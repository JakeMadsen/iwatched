<%
  // Build a safe user object for preview if not logged in
  const u = (typeof user !== 'undefined' && user) ? user : {
    _id: 'preview',
    local: { username: 'GuestUser' },
    profile: { custom_url: 'guest', profile_image: 'profile-picture-missing.png', banner_image: 'profile-banner-missing.png' },
    stats: { movies: 142, shows: 68, hours: 287 }
  };
  function avatarFor(userObj){
    try {
      if (userObj && userObj.profile && userObj.profile.profile_image && userObj.profile.profile_image !== 'profile-picture-missing.png'){
        return '/static/style/img/profile_images/users/' + userObj._id + '/' + userObj.profile.profile_image;
      }
    } catch(_){ }
    return '/static/style/img/profile_images/users/default/picture_default.png';
  }
  const avatarSrc = avatarFor(u);
  // Prepare page_data compatible with old profile partials
  var page_data = {
    user: u,
    numberOfMoviesWatched: (u.stats && u.stats.movies) || 0,
    numberOfShowsWatched: (u.stats && u.stats.shows) || 0,
    numberOfSeasonsWatched: (u.stats && u.stats.seasons) || 0,
    numberOfEpisodesWatched: (u.stats && u.stats.episodes) || 0,
    movie_watch_time: (u.stats && u.stats.movie_watch_time) || '-',
    show_watch_time: (u.stats && u.stats.show_watch_time) || '-',
    total_watch_time_text: (u.stats && u.stats.total_time_text) || '-'
  };
%>

<div class="temp-user" data-page="temp-user">
  <% /* legacy header moved to partials */ if(false){ %>
    <div class="th-shell">
      <div class="th-header__bar">
        <div class="th-logo">
          <span class="th-logo__word">iWatched</span>
          <span class="th-badge">BETA</span>
        </div>

        <nav class="th-nav th-nav--desktop" aria-label="Main navigation">
          <% navLinks.forEach(function(link) { %>
            <a class="th-nav__link" href="<%= link.href %>"><%= link.label %></a>
          <% }); %>
        </nav>

        <div class="th-header__actions">
          <!-- Global search (reuse old IDs for existing JS) -->
          <form id="nav_search_form" class="form-inline my-2 my-lg-0" action="/search" method="get" style="position:relative; z-index: 1100;">
            <div class="th-search">
              <span class="th-search__icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="11" cy="11" r="7"></circle>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
              </span>
              <input id="nav_search" name="q" class="th-search__input" type="search" placeholder="Search..." aria-label="Search" autocomplete="off">
              <div id="nav_search_results" class="dropdown-menu nav-search-menu"></div>
            </div>
          </form>

          <% if(typeof user != 'undefined'){ %>
            <% if( user.permissions.level.admin == true || user.permissions.level.moderator == true ) { %>
              <a href="/admin/" class="th-button th-button--ghost">Admin Panel</a>
            <% } %>
            <div class="dropdown">
              <a class="nav-link" href="#" id="navbarNotif" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Notifications" style="position:relative;">
                <i class="fas fa-bell"></i>
                <span id="notif_badge" class="badge badge-pill badge-danger" style="position:absolute; top:0; right:-4px; display:none;">0</span>
              </a>
              <div id="notif_menu" class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarNotif" style="min-width: 280px;">
                <span class="dropdown-item-text" style="opacity:.75;">No notifications</span>
              </div>
            </div>
            <div class="dropdown">
              <a class='nav-link dropdown-toggle th-userbtn' href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" aria-label="Open profile menu for <%= user.local.username %>">
                <img class="th-userbtn__avatar" src="<%= avatarFor(user) %>" alt="">
                <span class="th-userbtn__name"><%= user.local.username %></span>
              </a>
              <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                <% if(user.profile.custom_url != "" && user.profile.custom_url != null) { %>
                  <a class="dropdown-item" href="/<%= user.profile.custom_url %>">My Profile</a>
                  <a class="dropdown-item" href="/<%= user.profile.custom_url %>/settings">Settings</a>
                <% } else { %>
                  <a class="dropdown-item" href="/<%= user._id %>">My Profile</a>
                  <a class="dropdown-item" href="/<%= user._id %>/settings">Settings</a>
                <% } %>
                <a class="dropdown-item" href="/user/recommendations">Recommendations</a>
                <a class="dropdown-item" href="/user/badges">Badges</a>
                <a class="dropdown-item" href="/support">Support</a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="/logout">Log out</a>
              </div>
            </div>
          <% } else { %>
          <a class="th-button th-button--ghost" href="/login">Login</a>
            <a class="th-button th-button--primary" href="/login">Create Account</a>
          <% } %>
        </div>

        <button class="th-header__mobile-toggle" type="button" data-th-mobile-toggle aria-expanded="false" aria-controls="th-mobile-menu">
          <span class="sr-only">Toggle navigation</span>
          <span class="th-header__icon th-header__icon--menu" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="3" y1="6" x2="21" y2="6"></line>
              <line x1="3" y1="12" x2="21" y2="12"></line>
              <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
          </span>
          <span class="th-header__icon th-header__icon--close" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </span>
        </button>
      </div>
    </div>

    <div class="th-mobile-menu" id="th-mobile-menu" data-th-mobile-menu hidden>
      <div class="th-shell">
        <nav class="th-mobile-menu__links" aria-label="Mobile navigation">
          <% navLinks.forEach(function(link) { %>
            <a class="th-nav__link" href="<%= link.href %>"><%= link.label %></a>
          <% }); %>
        </nav>
        <div class="th-mobile-menu__search">
          <div class="th-search th-search--full">
            <span class="th-search__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="7"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
            </span>
            <input class="th-search__input" type="text" placeholder="Search...">
          </div>
        </div>
        <div class="th-mobile-menu__actions">
          <% if(typeof user == 'undefined'){ %>
            <a class="th-button th-button--ghost" href="/login">Login</a>
            <a class="th-button th-button--primary" href="/login">Create Account</a>
          <% } else { %>
            <% if( user.profile.custom_url != "" && user.profile.custom_url != null) { %>
              <a class="th-button th-button--ghost" href="/<%= user.profile.custom_url %>">My Profile</a>
              <a class="th-button th-button--ghost" href="/<%= user.profile.custom_url %>/settings">Settings</a>
            <% } else { %>
              <a class="th-button th-button--ghost" href="/<%= user._id %>">My Profile</a>
              <a class="th-button th-button--ghost" href="/<%= user._id %>/settings">Settings</a>
            <% } %>
            <a class="th-button th-button--ghost" href="/user/recommendations">Recommendations</a>
            <a class="th-button th-button--ghost" href="/support">Support</a>
            <a class="th-button th-button--primary" href="/logout">Log out</a>
          <% } %>
        </div>
      </div>
    </div>
  </header>

  <% } %>
  <div class="th-main">
    <!-- Old profile hero copied verbatim to preserve functionality and banner support -->
    <div id="profile_header" class="profile-hero" style="background-image: url('/static/style/img/profile_images/users/<%= page_data.user._id %>/<%= page_data.user.profile.banner_image %>');">
      <div class="container">
        <div class="container profile-hero__inner">
          <div class="profile-hero__left">
            <img class="profile-hero__avatar" src="<%= avatarSrc %>" alt="">
            <div class="profile-hero__meta">
              <h1 class="profile-hero__name"><%= page_data.user.local.username %></h1>
              <%
                const handle = (page_data.user.profile.custom_url && page_data.user.profile.custom_url !== '')
                  ? page_data.user.profile.custom_url
                  : (page_data.user.local.username || '');
                const handleBasePath = (page_data.user.profile.custom_url && page_data.user.profile.custom_url !== '')
                  ? '/' + page_data.user.profile.custom_url
                  : '/' + page_data.user._id;
              %>
              <% if (handle) { %>
                <div class="profile-hero__handle">
                  <a class="profile-hero__handle-link" href="<%= handleBasePath %>">@<%= handle %></a>
                  <% try { var fb = (page_data.user && page_data.user.profile && page_data.user.profile.featured_badge_info) || null; if (fb && fb.icon) { %>
                    <img src="<%= fb.icon %>" alt="<%= fb.title %>" title="<%= fb.title %><% if (fb.level && fb.level!=='single') { %> — <%= fb.level %><% } %><% if (fb.awarded_at) { %> — Awarded <%= new Date(fb.awarded_at).toLocaleDateString() %><% } %>\n<%= fb.description %>" style="width:18px;height:18px;object-fit:contain;margin-left:6px;vertical-align:middle;">
                  <% } } catch(_){} %>
                </div>
              <% } %>
              <% if (page_data.user.profile.description) { %>
                <p class="profile-hero__bio"><%= page_data.user.profile.description %></p>
              <% } %>
            </div>
          </div>
          <div class="profile-hero__actions">
            <%
              var basePath = (page_data.user.profile.custom_url && page_data.user.profile.custom_url !== '')
                ? '/' + page_data.user.profile.custom_url
                : '/' + page_data.user._id;
              var friendsCount = null;
            %>
            <a class="profile-hero__friends" href="<%= basePath %>/friends" title="Friends">
              <% if (friendsCount !== null) { %>
                <span><%= friendsCount %></span>
              <% } %>
              <i class="fas fa-user-friends"></i>
            </a>
            <% if (user && String(user._id) !== String(page_data.user._id)) { %>
              <div id="friend_cta"
                   data-viewer-id="<%= user._id %>"
                   data-viewer-key="<%= user.permissions.user_private_key %>"
                   data-profile-id="<%= page_data.user._id %>"></div>
            <% } %>
          </div>
        </div>
        <div class="profile-hero__overlay"></div>
      </div>
    </div>

    <div id="profile_section">
      <div class="container">
        <%- include('../partials/profile/profile_stats.ejs', { page_data: page_data }) %>
        <%- include('../partials/profile/profile_quicklinks.ejs', { page_data: page_data }) %>
        <%- include('../partials/profile/main.ejs', { page_data: page_data }) %>
      </div>
    </div>
  </div>

  

  <% if(typeof user == 'undefined'){ %>
    <a class="th-floating-cta" href="/login" aria-label="Join Beta">
      <span>Join Beta</span>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </a>
  <% } %>
</div>

<% /* moved to shared scripts */ if(false){ %>
<script>
  (function() {
    const header = document.querySelector('[data-th-header]');
    const toggle = document.querySelector('[data-th-mobile-toggle]');
    const mobileMenu = document.querySelector('[data-th-mobile-menu]');
    const setHeaderState = () => {
      if (!header) return;
      if (window.scrollY > 12) { header.classList.add('th-header--scrolled'); } else { header.classList.remove('th-header--scrolled'); }
    };
    window.addEventListener('scroll', setHeaderState, { passive: true }); setHeaderState();
    if (toggle && mobileMenu) {
      toggle.addEventListener('click', () => {
        const isOpen = mobileMenu.hasAttribute('hidden') === false;
        if (isOpen) { mobileMenu.setAttribute('hidden', ''); toggle.setAttribute('aria-expanded', 'false'); document.body.classList.remove('th-mobile-open'); }
        else { mobileMenu.removeAttribute('hidden'); toggle.setAttribute('aria-expanded', 'true'); document.body.classList.add('th-mobile-open'); }
      });
    }
  })();
</script>
<script>
  // Active nav link
  (function(){
    try {
      var path = window.location && window.location.pathname || '/';
      var links = document.querySelectorAll('.th-nav a.th-nav__link, .th-mobile-menu__links a.th-nav__link');
      links.forEach(function(a){
        var href = a.getAttribute('href') || '';
        var isMatch = href === '/' ? path === '/' : path.indexOf(href) === 0;
        if (isMatch) { a.classList.add('is-active'); a.setAttribute('aria-current', 'page'); }
      });
    } catch(_){}
  })();
</script>
<% } %>
