<div class="container" style="margin-top:16px;">
  <h1>Search</h1>
  <form action="/search" method="get" class="form-inline" style="margin:8px 0 16px 0;">
    <input type="text" class="form-control mr-sm-2" name="q" value="<%= page_data.q %>" placeholder="Search for movies, shows, users..." style="width: 360px;">
    <button class="btn btn-secondary" type="submit">Search</button>
  </form>

  <div id="search_results"></div>
</div>

<script>
  (function(){
    var holder = document.getElementById('search_results');
    var q = '<%- page_data.q.replace(/'/g, "&#39;") %>';
    if(!q){ holder.innerHTML = '<p style="opacity:.75;">Type a search above.</p>'; return; }
    fetch('/api/v1/search?q='+encodeURIComponent(q)+'&limit=20')
      .then(function(r){ return r.json(); })
      .then(function(data){
        function section(title, itemsHtml){
          if(!itemsHtml) return '';
          return '<h3>'+title+'</h3><div class="dropdown-divider"></div>'+itemsHtml;
        }
        function movieCard(m){
          return '<div class="col-md-2 image-box"><a href="/movies/'+m.id+'">'
           + '<img class="img-fluid image-box-hover" src="https://image.tmdb.org/t/p/w500/'+(m.poster_path||'')+'" alt=""></a>'
           + '<div class="movie-hover image-box-description"><div class="movie-title">'+(m.title||'')+'</div></div></div>';
        }
        function showCard(s){
          return '<div class="col-md-2 image-box"><a href="/shows/'+s.id+'">'
           + '<img class="img-fluid image-box-hover" src="https://image.tmdb.org/t/p/w500/'+(s.poster_path||'')+'" alt=""></a>'
           + '<div class="movie-hover image-box-description"><div class="movie-title">'+(s.name||'')+'</div></div></div>';
        }
        function userRow(u){
          var slug = u.slug ? '/'+u.slug : '/'+u.id;
          var av = u.avatar || '/static/style/img/profile_images/users/default/picture_default.png';
          return '<a href="'+slug+'" class="card" style="background:#1b1b1b;border-radius:10px;padding:12px;display:flex;align-items:center;gap:12px;color:#e0e0e0;text-decoration:none;margin-bottom:8px;">'
            + '<img src="'+av+'" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">'
            + '<div><div style="font-weight:700;">'+(u.username||u.slug||'User')+'</div>'
            + (u.slug?'<div style="opacity:.75;font-size:12px;">@'+u.slug+'</div>':'')
            + '</div></a>';
        }
        var movies = (data.movies||[]).map(movieCard).join('');
        var shows = (data.shows||[]).map(showCard).join('');
        var users = (data.users||[]).map(userRow).join('');
        holder.innerHTML =
          section('Movies', movies?'<div class="row">'+movies+'</div>':'')+
          section('Shows', shows?'<div class="row">'+shows+'</div>':'')+
          section('Users', users);
        if(!holder.innerHTML){ holder.innerHTML = '<p style="opacity:.75;">No results for "'+q+'".</p>'; }
      })
      .catch(function(){ holder.innerHTML = '<p style="opacity:.75;">Search failed.</p>'; });
  })();
</script>

