<div class="container" style="margin-top:16px;">
  <h1>Search</h1>
  <form action="/search" method="get" class="form-inline" style="margin:8px 0 16px 0;">
    <input type="text" class="form-control mr-sm-2" name="q" value="<%= page_data.q %>" placeholder="Search for movies, shows, people, users..." style="width: 360px;">
    <button class="btn btn-secondary" type="submit">Search</button>
  </form>

  <div id="search_wrap" style="position:relative;">
    <div id="search_nav" style="position:absolute; left:-120px; top:0; width:100px;">
      <!-- populated by script -->
    </div>
    <div id="search_results"></div>
  </div>
</div>

<script>
  (function(){
    var holder = document.getElementById('search_results');
    var nav = document.getElementById('search_nav');
    var q = '<%- page_data.q.replace(/'/g, "&#39;") %>';
    if(!q){ holder.innerHTML = '<p style="opacity:.75;">Type a search above.</p>'; return; }
    fetch('/api/v1/search?q='+encodeURIComponent(q)+'&limit=20')
      .then(function(r){ return r.json(); })
      .then(function(data){
        function section(title, id, itemsHtml){
          if(!itemsHtml) return '';
          return '<a id="'+id+'"></a><h3 style="margin-top:8px;">'+title+'</h3><div class="dropdown-divider"></div>'+itemsHtml;
        }
        function slugify(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').substring(0,80); }
        function movieCard(m){
          var slug = slugify(m.title||'');
          var html = '<div class="col-md-2 image-box"><a href="/movies/'+m.id+'-'+slug+'">'
           + '<img class="img-fluid image-box-hover" src="https://image.tmdb.org/t/p/w500/'+(m.poster_path||'')+'" alt=""></a>'
           + '<div class="movie-hover image-box-description"><div class="movie-title">'+(m.title||'')+'</div>';
          <% if (typeof user != 'undefined') { %>
          html += '<div class="movie-actions">'
            + '<i class="far fa-check-circle fa-2x icon-white" id="add_watched_movie_'+(m.id||'')+'" onclick="event.stopPropagation(); movieAddWatched(\'<%= user._id %>\', \'"+(m.id||"")+"\', \'\', \'<%= user.permissions.user_private_key %>\'); return false;"></i>'
            + '<i class="fas fa-check-circle fa-2x icon-green" id="remove_watched_movie_'+(m.id||'')+'" onclick="event.stopPropagation(); movieRemoveWatched(\'<%= user._id %>\', \'"+(m.id||"")+"\', \'\', \'<%= user.permissions.user_private_key %>\'); return false;"></i>'
            + '<i class="far fa-heart fa-2x icon-white" id="add_favourited_movie_'+(m.id||'')+'" onclick="event.stopPropagation(); movieAddFavourited(\'<%= user._id %>\', \'"+(m.id||"")+"\', \'\', \'<%= user.permissions.user_private_key %>\'); return false;"></i>'
            + '<i class="fas fa-heart fa-2x icon-red" id="remove_favourited_movie_'+(m.id||'')+'" onclick="event.stopPropagation(); movieRemoveFavourited(\'<%= user._id %>\', \'"+(m.id||"")+"\', \'\', \'<%= user.permissions.user_private_key %>\'); return false;"></i>'
            + '<i class="far fa-bookmark fa-2x icon-white" id="add_saved_movie_'+(m.id||'')+'" onclick="event.stopPropagation(); movieAddSaved(\'<%= user._id %>\', \'"+(m.id||"")+"\', \'\', \'<%= user.permissions.user_private_key %>\'); return false;"></i>'
            + '<i class="fas fa-bookmark fa-2x icon-blue" id="remove_saved_movie_'+(m.id||'')+'" onclick="event.stopPropagation(); movieRemoveSaved(\'<%= user._id %>\', \'"+(m.id||"")+"\', \'\', \'<%= user.permissions.user_private_key %>\'); return false;"></i>'
            + '</div>';
          <% } %>
          html += '</div></div>';
          return html;
        }
        function showCard(s){
          var slug = slugify(s.name);
          var href = '/shows/'+s.id+'-'+slug;
          var html = '<div class="col-md-2 image-box"><a href="'+href+'">'
            + '<img class="img-fluid image-box-hover" src="https://image.tmdb.org/t/p/w500/'+(s.poster_path||'')+'" alt=""></a>'
            + '<div class="movie-hover image-box-description"><div class="movie-title">'+(s.name||'')+'</div>';
          <% if (typeof user != 'undefined') { %>
          html += '<div class="movie-actions">'
            + '<i class="far fa-check-circle fa-2x icon-white" id="add_watched_show_'+(s.id||'')+'" onclick="event.stopPropagation(); showAddWatched(\'<%= user._id %>\', \'"+(s.id||"")+"\', \'\', \'<%= user.permissions.user_private_key %>\'); return false;"></i>'
            + '<i class="fas fa-check-circle fa-2x icon-green" id="remove_watched_show_'+(s.id||'')+'" onclick="event.stopPropagation(); showRemoveWatched(\'<%= user._id %>\', \'"+(s.id||"")+"\', \'\', \'<%= user.permissions.user_private_key %>\'); return false;"></i>'
            + '<i class="far fa-heart fa-2x icon-white" id="add_favourited_show_'+(s.id||'')+'" onclick="event.stopPropagation(); showAddFavourited(\'<%= user._id %>\', \'"+(s.id||"")+"\', \'<%= user.permissions.user_private_key %>\'); return false;"></i>'
            + '<i class="fas fa-heart fa-2x icon-red" id="remove_favourited_show_'+(s.id||'')+'" onclick="event.stopPropagation(); showRemoveFavourited(\'<%= user._id %>\', \'"+(s.id||"")+"\', \'<%= user.permissions.user_private_key %>\'); return false;"></i>'
            + '<i class="far fa-bookmark fa-2x icon-white" id="add_saved_show_'+(s.id||'')+'" onclick="event.stopPropagation(); showAddSaved(\'<%= user._id %>\', \'"+(s.id||"")+"\', \'<%= user.permissions.user_private_key %>\'); return false;"></i>'
            + '<i class="fas fa-bookmark fa-2x icon-blue" id="remove_saved_show_'+(s.id||'')+'" onclick="event.stopPropagation(); showRemoveSaved(\'<%= user._id %>\', \'"+(s.id||"")+"\', \'<%= user.permissions.user_private_key %>\'); return false;"></i>'
            + '</div>';
          <% } %>
          html += '</div></div>';
          return html;
        }
        function personCard(p){
          var href = '/person/'+p.id;
          var img = p.profile_path ? 'https://image.tmdb.org/t/p/w342/'+p.profile_path : '';
          return '<a class="card" href="'+href+'" style="background:#1b1b1b;border-radius:10px;padding:8px;display:flex;align-items:center;gap:10px;color:#e0e0e0;text-decoration:none;margin-bottom:8px;">'
            + (img?'<img src="'+img+'" style="width:42px;height:42px;border-radius:8px;object-fit:cover;">':'')
            + '<div><div style="font-weight:700;">'+(p.name||'Person')+'</div></div>'
            + '</a>';
        }
        function buildNav(items){
          if(!nav) return;
          var html = '';
          var labs = [];
          if(items.movies) labs.push({ id:'sec-movies', label:'Movies'});
          if(items.shows) labs.push({ id:'sec-shows', label:'Series'});
          if(items.persons) labs.push({ id:'sec-persons', label:'People'});
          if(items.users) labs.push({ id:'sec-users', label:'Users'});
          if(!labs.length){ nav.innerHTML=''; return; }
          html += '<div style="position:sticky; top:12px;">';
          html += '<div style="height:'+ (labs.length*60+20) +'px; border-left:3px solid rgba(255,255,255,.25); margin-left:30px; position:relative;">';
          labs.forEach(function(it, idx){
            var top = 10 + idx*60;
            html += '<div style="position:absolute; left:-6px; top:'+top+'px; width:12px; height:12px; background:#fff; border-radius:50%;"></div>';
            html += '<a href="#'+it.id+'" class="search-rail-link" data-target="'+it.id+'" style="position:absolute; left:20px; top:'+(top-6)+'px; color:#e0e0e0; text-decoration:none;">'+it.label+'</a>';
          });
          html += '</div></div>';
          nav.innerHTML = html;
        }
        function userRow(u){
          var slug = u.slug ? '/'+u.slug : '/'+u.id;
          var av = u.avatar || '/static/style/img/standard/standard_avatar.png';
          return '<a href="'+slug+'" class="card" style="background:#1b1b1b;border-radius:10px;padding:12px;display:flex;align-items:center;gap:12px;color:#e0e0e0;text-decoration:none;margin-bottom:8px;">'
            + '<img src="'+av+'" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">'
            + '<div><div style="font-weight:700;">'+(u.username||u.slug||'User')+'</div>'
            + (u.slug?'<div style="opacity:.75;font-size:12px;">@'+u.slug+'</div>':'')
            + '</div></a>';
        }
        var movies = (data.movies||[]).map(movieCard).join('');
        var shows = (data.shows||[]).map(showCard).join('');
        var persons = (data.persons||[]).map(personCard).join('');
        var users = (data.users||[]).map(userRow).join('');
        var html = '';
        if (movies) html += section('Movies','sec-movies','<div class="row">'+movies+'</div>');
        if (shows) html += section('Shows','sec-shows','<div class="row">'+shows+'</div>');
        if (persons) html += section('People','sec-persons',persons);
        if (users) html += section('Users','sec-users',users);
        holder.innerHTML = html;
        buildNav({ movies: !!movies, shows: !!shows, persons: !!persons, users: !!users });
        if(!holder.innerHTML){ holder.innerHTML = '<p style="opacity:.75;">No results for "'+q+'".</p>'; }

        // Initialize quick-action states for viewer
        <% if (typeof user != 'undefined') { %>
        try {
          var idsMovie = (data.movies||[]).map(function(m){ return m.id; }).filter(Boolean);
          var idsShow  = (data.shows||[]).map(function(s){ return s.id; }).filter(Boolean);
          idsMovie.forEach(function(id){ $('#add_watched_movie_'+id+',#remove_watched_movie_'+id+',#add_favourited_movie_'+id+',#remove_favourited_movie_'+id+',#add_saved_movie_'+id+',#remove_saved_movie_'+id).hide(); });
          idsShow.forEach(function(id){ $('#add_watched_show_'+id+',#remove_watched_show_'+id+',#add_favourited_show_'+id+',#remove_favourited_show_'+id+',#add_saved_show_'+id+',#remove_saved_show_'+id).hide(); });
          if (window.StatusStore){
            if (idsMovie.length){ StatusStore.request('movie', idsMovie).then(function(list){ (list||[]).forEach(function(st, idx){ var id=idsMovie[idx]; if(!id) return; (st&&st.w===true?$('#remove_watched_movie_'+id):$('#add_watched_movie_'+id)).show(); (st&&st.f===true?$('#remove_favourited_movie_'+id):$('#add_favourited_movie_'+id)).show(); (st&&st.s===true?$('#remove_saved_movie_'+id):$('#add_saved_movie_'+id)).show(); }); }); }
            if (idsShow.length){ StatusStore.request('show', idsShow).then(function(list){ (list||[]).forEach(function(st, idx){ var id=idsShow[idx]; if(!id) return; (st&&st.w===true?$('#remove_watched_show_'+id):$('#add_watched_show_'+id)).show(); (st&&st.f===true?$('#remove_favourited_show_'+id):$('#add_favourited_show_'+id)).show(); (st&&st.s===true?$('#remove_saved_show_'+id):$('#add_saved_show_'+id)).show(); }); }); }
          }
        } catch(_){}
        <% } %>
      })
      .catch(function(){ holder.innerHTML = '<p style="opacity:.75;">Search failed.</p>'; });
  })();
</script>

<style>
  @media (max-width: 992px){ #search_nav { display:none; } #search_wrap { padding-left:0; } }
  @media (min-width: 993px){ #search_wrap { padding-left: 0; } }
  .search-rail-link:hover{ text-decoration: underline; }
</style>
