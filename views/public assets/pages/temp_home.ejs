<%
  const navLinks = [
    { label: 'Home', href: '/' },
    { label: 'Movies', href: '/movies' },
    { label: 'Series', href: '/shows' }
  ];

  const heroBackgroundPattern = [];
  const shimmerDurations = [7.8, 8.6, 9.4, 10.1, 9.2, 8.9];
  function addTileRow(delayStart) {
    for (let i = 0; i < 12; i++) {
      const delay = (delayStart + i * 0.14).toFixed(2) + 's';
      const duration = shimmerDurations[i % shimmerDurations.length].toFixed(1) + 's';
      heroBackgroundPattern.push({ type: 'tile', delay, duration });
    }
  }

  addTileRow(0);
  heroBackgroundPattern.push({ type: 'bar', delay: '0.85s', duration: '12s' });
  addTileRow(1.4);
  heroBackgroundPattern.push({ type: 'bar', delay: '1.7s', duration: '11.4s' });
  addTileRow(2.3);

  const heroMetrics = [
    { label: 'Movies Watched', value: '142' },
    { label: 'Shows Watched', value: '68' },
    { label: 'Total Watch Time', value: '287h' }
  ];

  const featureCards = [
    {
      key: 'log',
      title: 'Log Movies & Series',
      description: 'Build your complete watch history with dates, ratings, and personal notes.',
      accent: 'blue'
    },
    {
      key: 'stats',
      title: 'Discover Your Stats',
      description: 'See your top genres, actors, and directors through beautiful visualizations.',
      accent: 'indigo'
    },
    {
      key: 'insights',
      title: 'Visualize Your Habits',
      description: 'Learn what kind of viewer you really are with personalized insights.',
      accent: 'purple'
    },
    {
      key: 'customize',
      title: 'Customize Your Profile',
      description: 'Unlock showcases, badges, and themes to express your cinematic taste.',
      accent: 'pink'
    }
  ];

  const trendingMovies = [
    { title: 'Dune: Part Two', image: 'https://images.unsplash.com/photo-1626814026160-2237a95fc5a0?auto=format&fit=crop&w=300&q=80' },
    { title: 'Oppenheimer', image: 'https://images.unsplash.com/photo-1440404653325-ab127d49abc1?auto=format&fit=crop&w=300&q=80' },
    { title: 'Poor Things', image: 'https://images.unsplash.com/photo-1536440136628-849c177e76a1?auto=format&fit=crop&w=300&q=80' },
    { title: 'Killers of the Flower Moon', image: 'https://images.unsplash.com/photo-1517604931442-7e0c8ed2963c?auto=format&fit=crop&w=300&q=80' },
    { title: 'Past Lives', image: 'https://images.unsplash.com/photo-1594909122845-11baa439b7bf?auto=format&fit=crop&w=300&q=80' },
    { title: 'The Zone of Interest', image: 'https://images.unsplash.com/photo-1478720568477-152d9b164e26?auto=format&fit=crop&w=300&q=80' },
    { title: 'Anatomy of a Fall', image: 'https://images.unsplash.com/photo-1485846234645-a62644f84728?auto=format&fit=crop&w=300&q=80' },
    { title: 'The Holdovers', image: 'https://images.unsplash.com/photo-1542204165-65bf26472b9b?auto=format&fit=crop&w=300&q=80' },
    { title: 'The Boy and the Heron', image: 'https://images.unsplash.com/photo-1518834107812-67b0b7c58434?auto=format&fit=crop&w=300&q=80' },
    { title: 'Barbie', image: 'https://images.unsplash.com/photo-1581417478175-a9ef18f210c2?auto=format&fit=crop&w=300&q=80' },
    { title: 'Saltburn', image: 'https://images.unsplash.com/photo-1568876694728-451bbf694b83?auto=format&fit=crop&w=300&q=80' },
    { title: 'Wonka', image: 'https://images.unsplash.com/photo-1634157703702-3c124b455499?auto=format&fit=crop&w=300&q=80' }
  ];
%>

<div class="temp-home" data-page="temp-home">
  <header class="th-header" data-th-header>
    <div class="th-shell">
      <div class="th-header__bar">
        <div class="th-logo">
          <span class="th-logo__word">iWatched</span>
          <span class="th-badge">BETA</span>
        </div>

        <nav class="th-nav th-nav--desktop" aria-label="Main navigation">
          <% navLinks.forEach(function(link) { %>
            <a class="th-nav__link" href="<%= link.href %>"><%= link.label %></a>
          <% }); %>
        </nav>

        <div class="th-header__actions">
          <!-- Global search (reuse old IDs for existing JS) -->
          <form id="nav_search_form" class="form-inline my-2 my-lg-0" action="/search" method="get" style="position:relative; z-index: 1100;">
            <div class="th-search">
              <span class="th-search__icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="11" cy="11" r="7"></circle>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
              </span>
              <input id="nav_search" name="q" class="th-search__input" type="search" placeholder="Search..." aria-label="Search" autocomplete="off">
              <div id="nav_search_results" class="dropdown-menu nav-search-menu"></div>
            </div>
          </form>

          <% if(typeof user != 'undefined'){ %>
            <% if( user.permissions.level.admin == true || user.permissions.level.moderator == true ) { %>
              <a href="/admin/" class="th-button th-button--ghost">Admin Panel</a>
            <% } %>

            <!-- Notifications dropdown (uses existing scripts.ejs logic) -->
            <div class="dropdown">
              <a class="nav-link" href="#" id="navbarNotif" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Notifications" style="position:relative;">
                <i class="fas fa-bell"></i>
                <span id="notif_badge" class="badge badge-pill badge-danger" style="position:absolute; top:0; right:-4px; display:none;">0</span>
              </a>
              <div id="notif_menu" class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarNotif" style="min-width: 280px;">
                <span class="dropdown-item-text" style="opacity:.75;">No notifications</span>
              </div>
            </div>

            <!-- User menu (avatar + username on desktop, avatar-only on tablet/phone) -->
            <div class="dropdown">
              <% var __avatar = (user && user.profile && user.profile.profile_image && user.profile.profile_image !== 'profile-picture-missing.png')
                ? ('/static/style/img/profile_images/users/' + user._id + '/' + user.profile.profile_image)
                : '/static/style/img/profile_images/users/default/picture_default.png'; %>
              <a class='nav-link dropdown-toggle th-userbtn' href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" aria-label="Open profile menu for <%= user.local.username %>">
                <img class="th-userbtn__avatar" src="<%= __avatar %>" alt="">
                <span class="th-userbtn__name"><%= user.local.username %></span>
              </a>
              <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                <% if(user.profile.custom_url != "" && user.profile.custom_url != null) { %>
                  <a class="dropdown-item" href="/<%= user.profile.custom_url %>">My Profile</a>
                  <a class="dropdown-item" href="/<%= user.profile.custom_url %>/settings">Settings</a>
                <% } else { %>
                  <a class="dropdown-item" href="/<%= user._id %>">My Profile</a>
                  <a class="dropdown-item" href="/<%= user._id %>/settings">Settings</a>
                <% } %>
                <a class="dropdown-item" href="/user/recommendations">Recommendations</a>
                <a class="dropdown-item" href="/user/badges">Badges</a>
                <a class="dropdown-item" href="/support">Support</a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="/logout">Log out</a>
              </div>
            </div>
          <% } else { %>
            <a class="th-button th-button--ghost" href="/login">Login</a>
            <a class="th-button th-button--primary" href="/signup">Create Account</a>
          <% } %>
        </div>

        <button class="th-header__mobile-toggle" type="button" data-th-mobile-toggle aria-expanded="false" aria-controls="th-mobile-menu">
          <span class="sr-only">Toggle navigation</span>
          <span class="th-header__icon th-header__icon--menu" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="3" y1="6" x2="21" y2="6"></line>
              <line x1="3" y1="12" x2="21" y2="12"></line>
              <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
          </span>
          <span class="th-header__icon th-header__icon--close" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </span>
        </button>
      </div>
    </div>

    <div class="th-mobile-menu" id="th-mobile-menu" data-th-mobile-menu hidden>
      <div class="th-shell">
        <nav class="th-mobile-menu__links" aria-label="Mobile navigation">
          <% navLinks.forEach(function(link) { %>
            <a class="th-nav__link" href="<%= link.href %>"><%= link.label %></a>
          <% }); %>
        </nav>
        <div class="th-mobile-menu__search">
          <div class="th-search th-search--full">
            <span class="th-search__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="7"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
            </span>
            <input class="th-search__input" type="text" placeholder="Search...">
          </div>
        </div>
        <div class="th-mobile-menu__actions">
          <% if(typeof user == 'undefined'){ %>
            <a class="th-button th-button--ghost" href="/login">Login</a>
            <a class="th-button th-button--primary" href="/signup">Create Account</a>
          <% } else { %>
            <% if( user.profile.custom_url != "" && user.profile.custom_url != null) { %>
              <a class="th-button th-button--ghost" href="/<%= user.profile.custom_url %>">My Profile</a>
              <a class="th-button th-button--ghost" href="/<%= user.profile.custom_url %>/settings">Settings</a>
            <% } else { %>
              <a class="th-button th-button--ghost" href="/<%= user._id %>">My Profile</a>
              <a class="th-button th-button--ghost" href="/<%= user._id %>/settings">Settings</a>
            <% } %>
            <a class="th-button th-button--ghost" href="/user/recommendations">Recommendations</a>
            <a class="th-button th-button--ghost" href="/support">Support</a>
            <a class="th-button th-button--primary" href="/logout">Log out</a>
          <% } %>
        </div>
      </div>
    </div>
  </header>

  <main class="th-main">
    <section class="th-section th-hero">
      <div class="th-hero__background" aria-hidden="true">
        <div class="th-hero__gradient"></div>
        <div class="th-hero__poster-grid">
          <% heroBackgroundPattern.forEach(function(item) { %>
            <div
              class="th-hero__poster <%= item.type === 'bar' ? 'th-hero__poster--bar' : '' %>"
              style="--delay:<%= item.delay %>;--duration:<%= item.duration %>;">
            </div>
          <% }); %>
        </div>
        <div class="th-hero__halo th-hero__halo--top" aria-hidden="true"></div>
        <div class="th-hero__halo th-hero__halo--bottom" aria-hidden="true"></div>
      </div>

      <div class="th-shell">
        <div class="th-hero__content">
          <h1 class="th-hero__title">Track. Analyze. Celebrate your movie life.</h1>
          <p class="th-hero__subtitle">
            Log everything you've watched and discover detailed insights about your viewing habits � from your most-watched genres to your favorite actors.
          </p>
        </div>

        <div class="th-hero__preview">
          <div class="th-preview-window">
            <div class="th-preview-window__bar">
              <span class="th-preview-dot th-preview-dot--red"></span>
              <span class="th-preview-dot th-preview-dot--yellow"></span>
              <span class="th-preview-dot th-preview-dot--green"></span>
              <span class="th-preview-bar"></span>
            </div>
            <div class="th-preview-window__body">
              <div class="th-preview-window__metrics">
                <% heroMetrics.forEach(function(metric) { %>
                  <div class="th-preview-metric">
                    <strong><%= metric.value %></strong>
                    <span><%= metric.label %></span>
                  </div>
                <% }); %>
              </div>
              <div class="th-preview-window__grid">
                <div class="th-preview-panel th-preview-panel--wide"></div>
                <div class="th-preview-panel"></div>
              </div>
            </div>
          </div>
          <span class="th-preview-glow th-preview-glow--one"></span>
          <span class="th-preview-glow th-preview-glow--two"></span>
        </div>
      </div>
    </section>

    <section class="th-section th-features" id="features">
      <div class="th-shell">
        <div class="th-section__heading">
          <h2>Your movie journey, enhanced</h2>
          <p>iWatched transforms how you track, remember, and share your entertainment experiences.</p>
        </div>

        <div class="th-feature-grid">
          <% featureCards.forEach(function(feature) { %>
            <div class="th-feature-card th-feature-card--<%= feature.accent %>">
              <div class="th-feature-card__icon">
                <% if (feature.key === 'log') { %>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                    <path d="M16 2v4"></path>
                    <path d="M8 2v4"></path>
                    <path d="M2 10h20"></path>
                  </svg>
                <% } else if (feature.key === 'stats') { %>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 3v18h18"></path>
                    <rect x="7" y="13" width="3" height="5" rx="1"></rect>
                    <rect x="12" y="9" width="3" height="9" rx="1"></rect>
                    <rect x="17" y="5" width="3" height="13" rx="1"></rect>
                  </svg>
                <% } else if (feature.key === 'insights') { %>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3.73 7.11a7.92 7.92 0 0 1 2.08-2.52"></path>
                    <path d="M2.05 13a8 8 0 0 1 4.5-10.9"></path>
                    <path d="M11 2a8 8 0 0 1 11 6"></path>
                    <path d="M21.95 11.05a8 8 0 0 1-4.5 10.9"></path>
                    <path d="M13 22a8 8 0 0 1-11-6"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                <% } else { %>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 3v18"></path>
                    <path d="M4 21a8 8 0 0 0 8-8"></path>
                    <path d="M4 3v18"></path>
                    <path d="M9 3h10"></path>
                    <path d="M9 21h10"></path>
                  </svg>
                <% } %>
              </div>
              <h3><%= feature.title %></h3>
              <p><%= feature.description %></p>
              <div class="th-feature-card__cta">
                Learn more
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </div>
            </div>
          <% }); %>
        </div>
      </div>
    </section>

    <section class="th-section th-beta">
      <div class="th-shell">
        <div class="th-beta__inner">
          <span class="th-beta__blob th-beta__blob--one" aria-hidden="true"></span>
          <span class="th-beta__blob th-beta__blob--two" aria-hidden="true"></span>
          <div class="th-beta__icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
          </div>
          <div class="th-beta__content">
            <h3>
              <span data-ann-title>iWatched BETA Access</span>
              <span class="th-badge th-badge--inline" data-ann-date style="display:none;"></span>
            </h3>
            <p class="th-beta__lead" data-ann-text>Loading the latest announcement...</p>
            <a class="th-link" data-ann-link href="/announcements">Discuss the latest update
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </a>
                        <p class="th-beta__note">Stay tuned for more updates as we continue to polish the iWatched experience.</p>

          </div>
        </div>
      </div>
    </section>

    <section class="th-section th-trending">
      <div class="th-shell">
        <div class="th-trending__head">
          <div>
            <h2>Trending Among iWatched Users</h2>
            <p>Data powered by TMDb &mdash; updated daily</p>
          </div>
          <a class="th-link" href="#">View all trending movies
            <span aria-hidden="true">&rarr;</span>
          </a>
        </div>

        <div class="th-trending__grid">
          <% trendingMovies.forEach(function(movie) { %>
            <article class="th-movie-card">
              <div class="th-movie-card__media">
                <img src="<%= movie.image %>" alt="<%= movie.title %> poster">
              </div>
              <div class="th-movie-card__overlay">
                <h3><%= movie.title %></h3>
              </div>
            </article>
          <% }); %>
        </div>
      </div>
    </section>
  </main>

  <footer class="th-footer">
    <div class="th-shell">
      <div class="th-footer__grid">
        <div>
          <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/movies">Movies</a></li>
            <li><a href="/shows">Series</a></li>
          </ul>
        </div>
        <div>
          <ul>
            <li><a href="/faq">FAQ</a></li>
            <li><a href="/about">About</a></li>
            <li><a href="/contact">Contact</a></li>
          </ul>
        </div>
        <div>
          <ul>
            <li><a href="/policy-tos">Terms of Service</a></li>
            <li><a href="/policy-privacy">Privacy Policy</a></li>
            <li><a href="/policy-community">Community Policy</a></li>
          </ul>
        </div>
      </div>

      <div class="th-footer__base">
        <div class="th-logo">
          <span class="th-logo__word">iWatched</span>
          <span class="th-badge">BETA</span>
        </div>
        <p>&copy; 2025 iWatched &mdash; A better way to see what you've seen.</p>
      </div>
    </div>
  </footer>

  <% if(typeof user == 'undefined'){ %>
    <button class="th-floating-cta" type="button">
      <span>Join Beta</span>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </button>
  <% } %>
</div>

<script>
  (function() {
    const header = document.querySelector('[data-th-header]');
    const toggle = document.querySelector('[data-th-mobile-toggle]');
    const mobileMenu = document.querySelector('[data-th-mobile-menu]');

    const setHeaderState = () => {
      if (!header) return;
      if (window.scrollY > 12) {
        header.classList.add('th-header--scrolled');
      } else {
        header.classList.remove('th-header--scrolled');
      }
    };

    window.addEventListener('scroll', setHeaderState, { passive: true });
    setHeaderState();

    if (toggle && mobileMenu) {
      toggle.addEventListener('click', () => {
        const isOpen = mobileMenu.hasAttribute('hidden') === false;
        if (isOpen) {
          mobileMenu.setAttribute('hidden', '');
          toggle.setAttribute('aria-expanded', 'false');
          document.body.classList.remove('th-mobile-open');
        } else {
          mobileMenu.removeAttribute('hidden');
          toggle.setAttribute('aria-expanded', 'true');
          document.body.classList.add('th-mobile-open');
        }
      });
    }

    const annTitleEl = document.querySelector('[data-ann-title]');
    const annDateEl = document.querySelector('[data-ann-date]');
    const annTextEl = document.querySelector('[data-ann-text]');
    const annLinkEl = document.querySelector('[data-ann-link]');
    const announcementsEndpoint = '/api/v1/announcements/latest';

    if (annTitleEl || annDateEl || annTextEl || annLinkEl) {
      fetch(announcementsEndpoint, { headers: { 'Accept': 'application/json' } })
        .then((response) => response.ok ? response.json() : null)
        .then((payload) => {
          if (!payload || !payload.announcement) return;
          const announcement = payload.announcement;
          if (!announcement) return;

          if (annTitleEl && announcement.title) {
            annTitleEl.textContent = announcement.title;
          }

          if (annTextEl) {
            const rawText = (announcement.text || '').trim();
            annTextEl.textContent = rawText || 'Latest announcement coming soon.';
          }

          if (annDateEl) {
            const dateSource = announcement.created_at || announcement.updated_at || null;
            if (dateSource) {
              try {
                const formatted = new Date(dateSource).toLocaleDateString('en-US', {
                  month: 'long',
                  day: 'numeric',
                  year: 'numeric'
                });
                annDateEl.textContent = formatted;
                annDateEl.style.display = '';
              } catch (_) {
                annDateEl.style.display = 'none';
              }
            } else {
              annDateEl.style.display = 'none';
            }
          }

          if (annLinkEl) {
            const linkBase = '/announcements';
            const idPart = announcement._id ? String(announcement._id) : '';
            const slugPart = announcement.slug ? String(announcement.slug) : '';
            const composed = idPart ? `${idPart}${slugPart ? `-${slugPart}` : ''}` : '';
            annLinkEl.href = composed ? `${linkBase}/${composed}` : linkBase;
          }
        })
        .catch(() => {});
    }
  })();
</script>

<script>
  // Mark active nav link based on current path
  (function(){
    try {
      var path = window.location && window.location.pathname || '/';
      var links = document.querySelectorAll('.th-nav a.th-nav__link, .th-mobile-menu__links a.th-nav__link');
      links.forEach(function(a){
        var href = a.getAttribute('href') || '';
        // Root must match exactly, others match path prefix
        var isMatch = href === '/' ? path === '/' : path.indexOf(href) === 0;
        if (isMatch) {
          a.classList.add('is-active');
          a.setAttribute('aria-current', 'page');
        } else {
          a.classList.remove('is-active');
          a.removeAttribute('aria-current');
        }
      });
    } catch(_){}
  })();
</script>
