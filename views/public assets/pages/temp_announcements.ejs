<%
  const navLinks = [
    { label: 'Home', href: '/' },
    { label: 'Movies', href: '/movies' },
    { label: 'Series', href: '/shows' }
  ];
%>

<div class="temp-announcements" data-page="temp-announcements">
  <header class="th-header" data-th-header>
    <div class="th-shell">
      <div class="th-header__bar">
        <div class="th-logo">
          <span class="th-logo__word">iWatched</span>
          <span class="th-badge">BETA</span>
        </div>

        <nav class="th-nav th-nav--desktop" aria-label="Main navigation">
          <% navLinks.forEach(function(link) { %>
            <a class="th-nav__link" href="<%= link.href %>"><%= link.label %></a>
          <% }); %>
        </nav>

        <div class="th-header__actions">
          <form id="nav_search_form" class="form-inline my-2 my-lg-0" action="/search" method="get" style="position:relative; z-index: 1100;">
            <div class="th-search">
              <span class="th-search__icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="11" cy="11" r="7"></circle>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
              </span>
              <input id="nav_search" name="q" class="th-search__input" type="search" placeholder="Search..." aria-label="Search" autocomplete="off">
              <div id="nav_search_results" class="dropdown-menu nav-search-menu"></div>
            </div>
          </form>

          <% if(typeof user != 'undefined'){ %>
            <% if( user.permissions.level.admin == true || user.permissions.level.moderator == true ) { %>
              <a href="/admin/" class="th-button th-button--ghost">Admin Panel</a>
            <% } %>
            <div class="dropdown">
              <a class="nav-link" href="#" id="navbarNotif" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Notifications" style="position:relative;">
                <i class="fas fa-bell"></i>
                <span id="notif_badge" class="badge badge-pill badge-danger" style="position:absolute; top:0; right:-4px; display:none;">0</span>
              </a>
              <div id="notif_menu" class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarNotif" style="min-width: 280px;">
                <span class="dropdown-item-text" style="opacity:.75;">No notifications</span>
              </div>
            </div>
            <div class="dropdown">
              <% var __avatar = (user && user.profile && user.profile.profile_image && user.profile.profile_image !== 'profile-picture-missing.png')
                ? ('/static/style/img/profile_images/users/' + user._id + '/' + user.profile.profile_image)
                : '/static/style/img/profile_images/users/default/picture_default.png'; %>
              <a class='nav-link dropdown-toggle th-userbtn' href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" aria-label="Open profile menu for <%= user.local.username %>">
                <img class="th-userbtn__avatar" src="<%= __avatar %>" alt="">
                <span class="th-userbtn__name"><%= user.local.username %></span>
              </a>
              <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                <% if(user.profile.custom_url != "" && user.profile.custom_url != null) { %>
                  <a class="dropdown-item" href="/<%= user.profile.custom_url %>">My Profile</a>
                  <a class="dropdown-item" href="/<%= user.profile.custom_url %>/settings">Settings</a>
                <% } else { %>
                  <a class="dropdown-item" href="/<%= user._id %>">My Profile</a>
                  <a class="dropdown-item" href="/<%= user._id %>/settings">Settings</a>
                <% } %>
                <a class="dropdown-item" href="/user/recommendations">Recommendations</a>
                <a class="dropdown-item" href="/user/badges">Badges</a>
                <a class="dropdown-item" href="/support">Support</a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="/logout">Log out</a>
              </div>
            </div>
          <% } else { %>
            <a class="th-button th-button--ghost" href="/login">Login</a>
            <a class="th-button th-button--primary" href="/signup">Create Account</a>
          <% } %>
        </div>

        <button class="th-header__mobile-toggle" type="button" data-th-mobile-toggle aria-expanded="false" aria-controls="th-mobile-menu">
          <span class="sr-only">Toggle navigation</span>
          <span class="th-header__icon th-header__icon--menu" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="3" y1="6" x2="21" y2="6"></line>
              <line x1="3" y1="12" x2="21" y2="12"></line>
              <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
          </span>
          <span class="th-header__icon th-header__icon--close" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </span>
        </button>
      </div>
    </div>

    <div class="th-mobile-menu" id="th-mobile-menu" data-th-mobile-menu hidden>
      <div class="th-shell">
        <nav class="th-mobile-menu__links" aria-label="Mobile navigation">
          <% navLinks.forEach(function(link) { %>
            <a class="th-nav__link" href="<%= link.href %>"><%= link.label %></a>
          <% }); %>
        </nav>
        <div class="th-mobile-menu__search">
          <div class="th-search th-search--full">
            <span class="th-search__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="7"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
            </span>
            <input class="th-search__input" type="text" placeholder="Search...">
          </div>
        </div>
        <div class="th-mobile-menu__actions">
          <% if(typeof user == 'undefined'){ %>
            <a class="th-button th-button--ghost" href="/login">Login</a>
            <a class="th-button th-button--primary" href="/signup">Create Account</a>
          <% } else { %>
            <% if( user.profile.custom_url != "" && user.profile.custom_url != null) { %>
              <a class="th-button th-button--ghost" href="/<%= user.profile.custom_url %>">My Profile</a>
              <a class="th-button th-button--ghost" href="/<%= user.profile.custom_url %>/settings">Settings</a>
            <% } else { %>
              <a class="th-button th-button--ghost" href="/<%= user._id %>">My Profile</a>
              <a class="th-button th-button--ghost" href="/<%= user._id %>/settings">Settings</a>
            <% } %>
            <a class="th-button th-button--ghost" href="/user/recommendations">Recommendations</a>
            <a class="th-button th-button--ghost" href="/support">Support</a>
            <a class="th-button th-button--primary" href="/logout">Log out</a>
          <% } %>
        </div>
      </div>
    </div>
  </header>

  <main class="th-main">
    <div class="th-shell ann-wrap">
      <% if (page_subFile === 'list') { %>
        <div class="ann-head">
          <h1>Announcements</h1>
          <% if (typeof user != 'undefined' && user.permissions && user.permissions.level && user.permissions.level.admin) { %>
            <a href="/admin/announcements" class="th-button th-button--ghost"><i class="fas fa-bullhorn"></i> New announcement</a>
          <% } %>
        </div>
        <div id="ann_list" class="ann-grid"></div>
        <div id="ann_pager" style="margin-top:16px;"></div>
      <% } %>
      <% if (page_subFile === 'one') { %>
        <div class="ann-one">
          <p><a class="th-link" href="/announcements">‚Üê Back to announcements</a></p>
          <div id="ann_one" class="ann-one__card"></div>
          <div id="ann_comments" class="ann-comments"></div>
          <% if (typeof user != 'undefined') { %>
            <div class="ann-one__card" style="margin-top:12px;">
              <h3 style="margin-top:0;">Add a comment</h3>
              <textarea id="ann_new_comment" class="form-control" rows="3" placeholder="Share your thoughts..."></textarea>
              <button id="ann_send_comment" class="th-button th-button--primary" style="margin-top:8px;">Post</button>
            </div>
          <% } else { %>
            <div style="margin-top:12px; opacity:.85;">Please <a class="th-link" href="/login">log in</a> to comment.</div>
          <% } %>
        </div>
      <% } %>
    </div>
  </main>

  <footer class="th-footer">
    <div class="th-shell">
      <div class="th-footer__grid">
        <div>
          <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/movies">Movies</a></li>
            <li><a href="/shows">Series</a></li>
          </ul>
        </div>
        <div>
          <ul>
            <li><a href="/faq">FAQ</a></li>
            <li><a href="/about">About</a></li>
            <li><a href="/contact">Contact</a></li>
          </ul>
        </div>
        <div>
          <ul>
            <li><a href="/policy-tos">Terms of Service</a></li>
            <li><a href="/policy-privacy">Privacy Policy</a></li>
            <li><a href="/policy-community">Community Policy</a></li>
          </ul>
        </div>
      </div>
      <div class="th-footer__base">
        <div class="th-logo">
          <span class="th-logo__word">iWatched</span>
          <span class="th-badge">BETA</span>
        </div>
        <p>&copy; 2025 iWatched &mdash; A better way to see what you've seen.</p>
      </div>
    </div>
  </footer>
</div>

<script>
  (function() {
    const header = document.querySelector('[data-th-header]');
    const toggle = document.querySelector('[data-th-mobile-toggle]');
    const mobileMenu = document.querySelector('[data-th-mobile-menu]');
    const setHeaderState = () => { if (!header) return; if (window.scrollY > 12) { header.classList.add('th-header--scrolled'); } else { header.classList.remove('th-header--scrolled'); } };
    window.addEventListener('scroll', setHeaderState, { passive: true }); setHeaderState();
    if (toggle && mobileMenu) { toggle.addEventListener('click', () => { const isOpen = mobileMenu.hasAttribute('hidden') === false; if (isOpen) { mobileMenu.setAttribute('hidden', ''); toggle.setAttribute('aria-expanded', 'false'); document.body.classList.remove('th-mobile-open'); } else { mobileMenu.removeAttribute('hidden'); toggle.setAttribute('aria-expanded', 'true'); document.body.classList.add('th-mobile-open'); } }); }
  })();
</script>
<script>
  // Active nav link
  (function(){ try { var path = window.location && window.location.pathname || '/'; var links = document.querySelectorAll('.th-nav a.th-nav__link, .th-mobile-menu__links a.th-nav__link'); links.forEach(function(a){ var href = a.getAttribute('href') || ''; var isMatch = href === '/' ? path === '/' : path.indexOf(href) === 0; if (isMatch) { a.classList.add('is-active'); a.setAttribute('aria-current','page'); }}); } catch(_){} })();
</script>

<% if (page_subFile === 'list') { %>
<script>
  (function(){
    var page = 1;
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, function(c){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]); }); }
    function truncate(s, n){ s = String(s||''); return s.length>n ? s.slice(0,n-1)+'‚Ä¶' : s; }
    function load(){
      fetch('/api/v1/announcements?page='+page+'&size=10').then(function(r){ return r.json(); }).then(function(d){
        var wrap = document.getElementById('ann_list'); var pager = document.getElementById('ann_pager'); wrap.innerHTML='';
        (d.items||[]).forEach(function(a){
          var slug = (a.slug||'').toString();
          var ccount = (a.comments||[]).length;
          var card = document.createElement('article'); card.className = 'ann-card';
          card.innerHTML = '<h3 class="ann-card__title"><a class="th-link" href="/announcements/'+a._id+(slug?('-'+slug):'')+'">'+escapeHtml(a.title||'')+'</a></h3>'
            + '<div class="ann-card__meta">'+ new Date(a.created_at).toLocaleString() +'</div>'
            + '<p class="ann-card__text">'+ escapeHtml(truncate(a.text||'', 240)) +'</p>'
            + '<span class="ann-card__comments"><i class="fas fa-comments"></i> '+ ccount +'</span>';
          wrap.appendChild(card);
        });
        var totalPages = Math.max(1, Math.ceil((d.total||0)/(d.size||10)));
        pager.innerHTML = '<div class="btn-group">'
          + '<button class="btn btn-sm btn-secondary" '+(page<=1?'disabled':'')+' id="prevBtn">Prev</button>'
          + '<span class="btn btn-sm btn-dark">'+page+'/'+totalPages+'</span>'
          + '<button class="btn btn-sm btn-secondary" '+(page>=totalPages?'disabled':'')+' id="nextBtn">Next</button>'
          + '</div>';
        var prev = document.getElementById('prevBtn'); var next = document.getElementById('nextBtn');
        prev && (prev.onclick = function(){ page=Math.max(1,page-1); load(); });
        next && (next.onclick = function(){ page=page+1; load(); });
      });
    }
    document.addEventListener('DOMContentLoaded', load);
  })();
</script>
<% } %>

<% if (page_subFile === 'one') { %>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<script>
  (function(){
    var id = <%- JSON.stringify(page_data.id) %>;
    function renderOne(a){
      var el = document.getElementById('ann_one');
      if(!a){ el.innerHTML = '<div>Announcement not found.</div>'; return; }
      var slug = (a.slug||'').toString();
      el.innerHTML = '<h1 class="ann-one__title">'+ (a.title||'') +'</h1>'
        + '<div class="ann-one__meta">'+ new Date(a.created_at).toLocaleString() +'</div>'
        + '<div id="ann_body" class="ann-body"></div>'
        + '<div class="ann-actions">'
        + (function(){ try { if(<%- JSON.stringify(!!(typeof user != 'undefined' && user.permissions && user.permissions.level && user.permissions.level.admin)) %>){ return '<a class="th-button th-button--ghost" href="/admin/announcements?edit='+a._id+'"><i class="fas fa-edit"></i> Edit</a>'; } } catch(_){ } return ''; })()
        + '</div>';
      try { if(window.marked && window.DOMPurify){ document.getElementById('ann_body').innerHTML = DOMPurify.sanitize(marked.parse(a.text||'')); } else { document.getElementById('ann_body').innerHTML = (a.text||'').replace(/\n/g,'<br>'); } } catch(_){}
      try { fetch('/api/v1/announcements/'+a._id+'/impression', { method:'POST', headers:{'Content-Type':'application/json'} }); } catch(_){ }
    }
    function buildCommentHTML(c, isReply, repliesCount){
      var avatar = c.user_avatar || '/static/style/img/profile_images/users/default/picture_default.png';
      var handle = c.user_handle || ('@'+(c.username||'user'));
      var link = c.user_link || '#';
      var edited = c.edited_at ? ' <em style=\"opacity:.8;\">edited</em>' : '';
      var content = c.deleted ? '<em style=\"opacity:.8;\">-deleted-</em>' : '<div class=\"ann-comment\" data-id=\"'+c._id+'\" style=\"margin-top:6px;\"></div>';
      var actions = '';
      var canEdit = <%- JSON.stringify(typeof user != 'undefined') %> && String(c.user_id||'') === <%- JSON.stringify(typeof user != 'undefined' ? String(user._id) : '') %>;
      var isAdmin = <%- JSON.stringify(typeof user != 'undefined' && user.permissions && user.permissions.level && user.permissions.level.admin) %>;
      var parentAttr = (c._root ? ' data-parent=\"'+c._root+'\"' : '');
      var handlePlain = (handle||'').replace(/^@/,'');
      actions += !c.deleted ? '<button class=\"btn btn-sm btn-outline-secondary js-reply\" data-id=\"'+c._id+'\"'+parentAttr+' data-handle=\"'+handlePlain+'\">Reply</button>' : '';
      actions += (!c.deleted && canEdit) ? ' <button class=\"btn btn-sm btn-outline-secondary js-edit\" data-id=\"'+c._id+'\">Edit</button>' : '';
      if (isAdmin) { actions += ' <div class=\"btn-group\" role=\"group\">'
        + '<button class=\"btn btn-sm btn-outline-danger js-delete\" data-id=\"'+c._id+'\" data-mode=\"soft\">Delete</button>'
        + '<button class=\"btn btn-sm btn-danger js-delete\" data-id=\"'+c._id+'\" data-mode=\"hard\" title=\"Remove comment and its replies\">Hard delete</button>'
        + '</div>'; } else if (!c.deleted && canEdit) { actions += ' <button class=\"btn btn-sm btn-outline-danger js-delete\" data-id=\"'+c._id+'\" data-mode=\"soft\">Delete</button>'; }
      var upCls = c.user_vote==='up' ? 'btn-success' : 'btn-outline-secondary';
      var downCls = c.user_vote==='down' ? 'btn-danger' : 'btn-outline-secondary';
      var votes = '<div class=\"btn-group btn-group-sm\" role=\"group\" aria-label=\"Vote\">'
        + '<button class=\"btn '+upCls+' js-vote\" data-id=\"'+c._id+'\" data-action=\"up\"><i class=\"fas fa-arrow-up\"></i> <span class=\"js-up\">'+(c.upvote_count||0)+'</span></button>'
        + '<button class=\"btn '+downCls+' js-vote\" data-id=\"'+c._id+'\" data-action=\"down\"><i class=\"fas fa-arrow-down\"></i> <span class=\"js-down\">'+(c.downvote_count||0)+'</span></button>'
        + '</div>';
      var reportBtn = '';
      try { var currentUser = <%- JSON.stringify(typeof user != 'undefined' ? String(user._id) : '') %>; if(currentUser && String(c.user_id) !== String(currentUser)){ reportBtn = ' <button class=\"btn btn-sm btn-outline-warning js-report\" data-target=\"'+c.user_id+'\" data-comment=\"'+c._id+'\" title=\"Report user\">Report</button>'; } } catch(_){ }
      var controls = '<div class=\"ann-controls\" style=\"display:flex; align-items:center; gap:8px; flex-wrap:wrap;\">'+votes+' <span style=\"flex:1 1 auto;\"></span> '+actions+reportBtn+'</div>';
      var toggle = (!isReply && (repliesCount||0) > 0) ? '<button class=\"ann-toggle js-toggle-replies\" data-parent=\"'+c._id+'\" aria-expanded=\"true\" title=\"Toggle replies\"><i class=\"fas fa-chevron-down\"></i></button>' : '';
      var outerOpen = isReply ? '<div class=\"ann-reply\">' : '';
      var outerClose = isReply ? '</div>' : '';
      return outerOpen
        + '<div class=\"ann-comment-user\">'
        +   '<a href=\"'+link+'\"><img src=\"'+avatar+'\" alt=\"\"></a>'
        +   '<div><a class=\"th-link\" href=\"'+link+'\">'+handle+'</a>'+edited+'</div>'
        +   toggle
        + '</div>'
        + content
        + controls
        + '<div class=\"reply-edit-holder\" data-id=\"'+c._id+'\" style=\"display:none;\"></div>'
        + outerClose;
    }
    function renderComments(a){
      var wrap = document.getElementById('ann_comments');
      var list = (a && a.comments) || [];
      // Old behavior: flat list with parent_id; build threads
      list.sort(function(x,y){ return new Date(x.created_at)-new Date(y.created_at); });
      var parents = list.filter(function(c){ return !c.parent_id; });
      var byParent = {};
      list.forEach(function(c){ if(c.parent_id){ var k=String(c.parent_id); (byParent[k]=byParent[k]||[]).push(c); } });
      var visibleCount = parents.length + parents.reduce(function(acc,p){ var rs=(byParent[String(p._id)]||[]); return acc + rs.filter(function(r){ return !r.deleted; }).length; }, 0);
      var html = '<h4>Comments ('+visibleCount+')</h4>';
      if(visibleCount===0){ html += '<div style="opacity:.75;">No comments yet.</div>'; }
      parents.forEach(function(p){
        html += '<div class="ann-one__card" style="margin-top:12px;">';
        var __replies = (byParent[String(p._id)]||[]);
        html += buildCommentHTML(p,false, __replies.filter(function(r){ return !r.deleted; }).length);
        html += '<div class=\"ann-replies\" data-parent=\"'+p._id+'\" style=\"display:block;\">';
        __replies.forEach(function(r){ if(!r.deleted){ html += buildCommentHTML(Object.assign({}, r, { _root: p._id }), true); } });
        html += '</div>';
        html += '</div>';
      });
      wrap.innerHTML = html;
      // Fill text placeholders with message markdown
      try {
        var map = {}; list.forEach(function(it){ map[String(it._id)] = it; });
        wrap.querySelectorAll('.ann-comment').forEach(function(node){
          var id = node.getAttribute('data-id'); var item = map[id]; if(!item) return;
          try { if(window.marked && window.DOMPurify){ node.innerHTML = DOMPurify.sanitize(marked.parse(String(item.message||''))); } else { node.textContent = item.message || ''; } } catch(_){ node.textContent = item.message || ''; }
        });
      } catch(_){}
    }
    function load(){ fetch('/api/v1/announcements/'+id).then(function(r){ return r.json(); }).then(function(d){ var a = d.announcement; renderOne(a); renderComments(a); }); }
    document.addEventListener('DOMContentLoaded', function(){
      load();
      var btn = document.getElementById('ann_send_comment'); if(btn){ btn.addEventListener('click', function(){ var msg = document.getElementById('ann_new_comment').value.trim(); if(!msg) return; fetch('/api/v1/announcements/'+id+'/comment', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ message: msg }) }).then(function(r){ return r.json(); }).then(function(){ document.getElementById('ann_new_comment').value=''; load(); }); }); }
      document.getElementById('ann_comments').addEventListener('click', function(e){ var target = e.target; var btn = target.closest('.js-reply'); if(btn){ var cid = btn.getAttribute('data-id'); var parent = btn.getAttribute('data-parent') || cid; var holder = document.querySelector('.reply-edit-holder[data-id="'+cid+'"]'); if(holder){ holder.style.display = holder.style.display==='none' || holder.style.display==='' ? 'block' : 'none'; if(holder.innerHTML==='') holder.innerHTML = '<textarea class=\"form-control\" rows=\"2\" placeholder=\"Write a reply...\">@'+(btn.getAttribute('data-handle')||'')+' </textarea><button class=\"btn btn-sm btn-primary js-send-reply\" data-id=\"'+cid+'\" data-parent=\"'+parent+'\" style=\"margin-top:6px;\">Reply</button>'; } return; } btn = target.closest('.js-send-reply'); if(btn){ var cid = btn.getAttribute('data-parent') || btn.getAttribute('data-id'); var holder = btn.parentElement; var ta = holder.querySelector('textarea'); var msg = (ta && ta.value||'').trim(); if(!msg) return; fetch('/api/v1/announcements/'+id+'/comment/'+cid+'/reply', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ message: msg, reply_to: btn.getAttribute('data-id') })}).then(function(r){ return r.json(); }).then(function(){ load(); }); return; } btn = target.closest('.js-edit'); if(btn){ var cid = btn.getAttribute('data-id'); var holder = document.querySelector('.reply-edit-holder[data-id="'+cid+'"]'); if(holder){ var itemEl = document.querySelector('.ann-comment[data-id="'+cid+'"]'); var current = itemEl ? itemEl.textContent : ''; holder.style.display = 'block'; holder.innerHTML = '<textarea class=\"form-control\" rows=\"3\">'+current.replace(/</g,'&lt;')+'</textarea><button class=\"btn btn-sm btn-primary js-save-edit\" data-id=\"'+cid+'\" style=\"margin-top:6px;\">Save</button>'; } return; } btn = target.closest('.js-save-edit'); if(btn){ var cid = btn.getAttribute('data-id'); var holder = btn.parentElement; var ta = holder.querySelector('textarea'); var msg = (ta && ta.value||'').trim(); if(!msg) return; fetch('/api/v1/announcements/'+id+'/comment/'+cid+'/edit', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ message: msg })}).then(function(r){ return r.json(); }).then(function(){ load(); }); return; } btn = target.closest('.js-delete'); if(btn){ var cid = btn.getAttribute('data-id'); var mode = btn.getAttribute('data-mode') || 'soft'; var msg = mode==='hard' ? 'Hard delete this comment and its replies? This cannot be undone.' : 'Delete this comment?'; if(!confirm(msg)) return; fetch('/api/v1/announcements/'+id+'/comment/'+cid+'/delete', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ mode: mode }) }).then(function(r){ return r.json(); }).then(function(){ load(); }); return; } btn = target.closest('.js-vote'); if(btn){ var cid = btn.getAttribute('data-id'); var action = btn.getAttribute('data-action'); var isActive = btn.classList.contains('btn-success') || btn.classList.contains('btn-danger'); var send = isActive ? 'clear' : action; fetch('/api/v1/announcements/'+id+'/comment/'+cid+'/vote', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ action: send })}).then(function(r){ return r.json(); }).then(function(){ load(); }); return; } var tog = target.closest('.js-toggle-replies'); if(tog){ var pid = tog.getAttribute('data-parent'); var box = document.querySelector('.ann-replies[data-parent="'+pid+'"]'); var expanded = tog.getAttribute('aria-expanded') === 'true'; if(box){ box.style.display = expanded ? 'none' : 'block'; } tog.setAttribute('aria-expanded', expanded ? 'false' : 'true'); var ico = tog.querySelector('i'); if(ico){ if(expanded){ ico.classList.remove('fa-chevron-down'); ico.classList.add('fa-chevron-right'); } else { ico.classList.remove('fa-chevron-right'); ico.classList.add('fa-chevron-down'); } } return; } });
    });
  })();
</script>
<script>
  // Extra handler for report and reply toggle in case earlier listener misses it
  (function(){
    var wrap = document.getElementById('ann_comments');
    if(!wrap) return;
    wrap.addEventListener('click', function(e){
      var t = e.target;
      var rp = t.closest && t.closest('.js-report');
      if(rp){
        try {
          var id = <%- JSON.stringify(page_data.id) %>;
          var targetUser = rp.getAttribute('data-target');
          var commentId = rp.getAttribute('data-comment');
          var reason = window.prompt('Report reason (optional):','') || '';
          fetch('/api/v1/reports', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ reported_user_id: targetUser, reason: reason, context:'comment', meta:{ comment_id: commentId, announcement_id: id } }) })
            .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
            .then(function(){ alert('Thanks for your report. Our moderators will review it.'); })
            .catch(function(){ alert('Could not submit report.'); });
        } catch(_){}
        return;
      }
      var tog = t.closest && t.closest('.js-toggle-replies');
      if(tog){
        var pid = tog.getAttribute('data-parent');
        var box = document.querySelector('.ann-replies[data-parent="'+pid+'"]');
        var expanded = tog.getAttribute('aria-expanded') === 'true';
        if(box){ box.style.display = expanded ? 'none' : 'block'; }
        tog.setAttribute('aria-expanded', expanded ? 'false' : 'true');
        var ico = tog.querySelector('i');
        if(ico){ if(expanded){ ico.classList.remove('fa-chevron-down'); ico.classList.add('fa-chevron-right'); } else { ico.classList.remove('fa-chevron-right'); ico.classList.add('fa-chevron-down'); } }
      }
    });
  })();
</script>
<% } %>
