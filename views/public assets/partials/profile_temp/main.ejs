<div id="profile_activity" class="container" style="margin-top: 24px;">
  <h3>Latest watched activity (new)</h3>
  <div id="movies_holder" class="row"></div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    tempProfileMoviesLatest('<%= page_data.user._id%>')
  });

  function tempProfileMoviesLatest(user_id) {
    $('#view_more').show()

    var link = `/api/v1/user-movies/latest/${user_id}`;
    var host = location.origin;
    var posterlink = `/api/v1/movies/get_poster/`;

    var $container = $('#movies_holder').infiniteScroll({
        path: function () {
            return link;
        },
        responseType: 'text',
        loadOnScroll: false,
        status: '.page-load-status',
        history: true,
    });

    $container.on('load.infiniteScroll', function (event, response) {
        var data = JSON.parse(response);
        var itemsHTML = data.results.map(getItemHTML).join('');
        var $items = $(itemsHTML);
        $container.infiniteScroll('appendItems', $items);
    });

    $container.infiniteScroll('loadNextPage');

    var itemTemplateSrc = $('#movie-template').html();
    function getItemHTML(movie) {
        getPoster(movie.tmd_id)
        try { movie.slug = slugify(movie.title || movie.name || movie.movie_title || ''); } catch(_) { movie.slug = ''; }
        return microTemplate(itemTemplateSrc, movie);
    }

    function microTemplate(src, data) {
        return src.replace(/\{\{([\w\-_\.]+)\}\}/gi, function (match, key) {
            var value = data; key.split('.').forEach(function (part) { value = value[part]; }); return value;
        });
    }

    function slugify(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').substring(0,80); }

    function getPoster(movie_id) {
        let url = host + posterlink + movie_id;
        let tmdImageLink= "https://image.tmdb.org/t/p/w500/";
        fetch(url).then(r => r.json()).then(data => {
            $(`[name='movie_id_${movie_id}']`).attr("src", tmdImageLink+data.poster_path);
        }).catch(console.log);
    }
  }
</script>

<% include ../profile/movie_template.ejs %>

