<div id="profile_section" class="container">

    <div class="settings-card" style="margin-bottom:24px;">
        <h2>Tier Status</h2>
        <div class="row">
            <div class="col-md-12">
                <p style="margin:0 0 8px;">Your current plan: <strong><span id="account_plan">Free</span></strong></p>
                <div>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="upgrade_btn">Upgrade to Premium</button>
                </div>
            </div>
        </div>
    </div>

    <div class="settings-card" style="margin-bottom:24px;">
        <h2>Active Sessions</h2>
        <p class="text" style="margin-top:-6px;">See where you're logged in and sign out of other devices.</p>
        <div class="table-responsive">
            <table class="table table-sm" style="color: #ffff;">
                <thead>
                    <tr >
                        <th >Device / Browser</th>
                        <th>IP</th>
                        <th >Location</th>
                        <th >Last Seen</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="sessions_table" style="color: #ffff;">
                    <tr><td colspan="5" class="text">Loading sessionsâ€¦</td></tr>
                </tbody>
            </table>
        </div>
        <button class="btn btn-secondary btn-sm" id="logout_others_btn">Log out other sessions</button>
    </div>

    <div class="settings-card">
    <h2>Profile Settings</h2>

    <form action="/<%= user._id %>/settings" method="POST" encType="multipart/form-data">
        <!-- Images -->
        <div class="row">
            <div class="col-md-6">
                <div class="profile-picture">
                    <label for="profile-picture-file">Profile Picture</label>
                    <div class="profile-picture-file">
                        <input name="profilePictureFile" type="file" id="profilePictureFile">
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="profile-banner">
                    <label for="profile-banner-file">Banner Image</label>
                    <div class="profile-banner-file">
                        <input type="hidden" value="<%= user._id %>">
                        <input name="profileBannerFile" type="file" id="profileBannerFile">
                    </div>
                </div>
            </div>
        </div>

        <!-- Featured badge -->
        <div class="row" style="margin-top:10px;">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="featured_badge">Featured Badge</label>
                    <select class="form-control" id="featured_badge" name="featured_badge">
                        <% var currentFeatured = (user.profile && user.profile.featured_badge_id) ? String(user.profile.featured_badge_id) : ''; %>
                        <option value="">None</option>
                        <% (page_data.badges||[]).forEach(function(b){ %>
                            <option value="<%= b.id %>" data-icon="<%= b.icon || '' %>" <%= currentFeatured===String(b.id)?'selected':'' %>><%= b.title %><%= (b.level && b.level!=='single') ? (' ('+b.level+')') : '' %></option>
                        <% }) %>
                    </select>
                    <small class="form-text text-muted">Choose a badge to display next to your handle across the site.</small>
                    <div style="margin-top:8px;">
                      <img id="featured_badge_preview" src="" style="display:none;width:28px;height:28px;object-fit:contain;" alt="Featured badge preview">
                    </div>
                </div>
            </div>
        </div>

        <hr>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="user_username">Username</label>
                    <input name="username" type="text" class="form-control" id="user_username" aria-describedby="usernameHelp"
                        value="<%= user.local.username %>" readonly>
                    <small id="usernamelHelp" class="form-text text-muted">Username cannot be changed</small>
                </div>

                <div class="form-group">
                    <label for="user_email">Email</label>
                    <input name="email" type="email" class="form-control" id="user_email" value="<%= user.local.email %>">
                </div>

                <div class="form-group">
                    <label for="user_password">Password</label>
                    <input name="password" type="password" class="form-control" id="user_password" value="">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="user_custom_url">Custom URL</label>
                    <input name="custom_url" type="text" class="form-control" id="user_custom_url" aria-describedby="user_custom_urlHelp"
                        value="<%= user.profile.custom_url %>" >
                    <small id="user_custom_urlHelp" class="form-text text-muted">Add a custom url to easily share your profile with friends.</small>
                </div>

                <div class="form-group">
                    <label for="editor_email">Birthday</label>
                    <input name="birthday" type="date" class="form-control" id="editor_name" value="<%= user.profile.birthday %>">
                </div>

                <div class="form-group">
                    <label for="user_password_confirm">Confirm Password</label>
                    <input name="password_confirm" type="password" class="form-control" id="user_password_confirm"
                        value="">
                </div>

                <div class="form-group">
                    <label for="profile_visibility">Profile Visibility</label>
                    <select class="form-control" id="profile_visibility" name="visibility">
                        <option value="public" <%= (user.profile.visibility === 'public') ? 'selected' : '' %>>Public</option>
                        <option value="friends" <%= (user.profile.visibility === 'friends') ? 'selected' : '' %>>Friends only</option>
                        <option value="private" <%= (user.profile.visibility === 'private') ? 'selected' : '' %>>Private</option>
                    </select>
                    <small class="form-text text-muted">Control who can view your profile and activity.</small>
                </div>
            </div>
        </div>

        <!-- Description -->
        <div class="form-group">
            <label for="editor_description">Profile Description</label>
            <textarea name="description" rows="6" class="form-control" id="editor_description" placeholder=""><%= user.profile.description %></textarea>
        </div>

        <button type="submit" class="btn btn-primary">Update Settings</button>
    </form>

    <script>
        var password = document.getElementById("user_password")
            , confirm_password = document.getElementById("user_password_confirm");

        function validatePassword() {
            if (password.value != confirm_password.value) {
                confirm_password.setCustomValidity("Passwords Don't Match");
            } else {
                confirm_password.setCustomValidity('');
            }
        }

        password.onchange = validatePassword;
        confirm_password.onkeyup = validatePassword;
    </script>
    <script>
      (function(){
        function updatePreview(){
          try {
            var sel = document.getElementById('featured_badge');
            var opt = sel && sel.options[sel.selectedIndex];
            var icon = opt ? (opt.getAttribute('data-icon')||'') : '';
            var img = document.getElementById('featured_badge_preview');
            if (!img) return;
            if (icon) { img.src = icon; img.style.display='inline-block'; }
            else { img.style.display='none'; img.src=''; }
          } catch(_){}
        }
        document.addEventListener('DOMContentLoaded', function(){
          var sel = document.getElementById('featured_badge');
          if (sel){ sel.addEventListener('change', updatePreview); updatePreview(); }
        });
      })();
    </script>
    </div>
</div>

<script>
  (function(){
    function fmtDate(d){ try { var dt = new Date(d); return dt.toLocaleString(); } catch(e) { return ''; } }
    function renderSessions(data){
      var tbody = document.getElementById('sessions_table');
      if(!tbody) return;
      var rows = '';
      (data.sessions||[]).forEach(function(s){
        var loc = (s.geo && (s.geo.city||s.geo.region||s.geo.country)) ? [s.geo.city, s.geo.region, s.geo.country].filter(Boolean).join(', ') : '-';
        var ua = (s.user_agent||'').split(')')[0];
        var badge = s.current ? '<span class="badge badge-success">Current</span>' : (s.active?'<span class="badge badge-info">Active</span>':'<span class="badge badge-secondary">Offline</span>');
        var action = s.current ? '' : '<button class="btn btn-link btn-sm js-revoke" data-sid="'+s.sid+'">Log out</button>';
        rows += '<tr>'+
          '<td style="max-width:280px;word-break:break-word;">'+ (ua||'Unknown') +' '+badge+'</td>'+
          '<td>'+(s.ip||'-')+'</td>'+
          '<td>'+loc+'</td>'+
          '<td>'+fmtDate(s.last_seen_at)+'</td>'+
          '<td>'+action+'</td>'+
        '</tr>';
      });
      if (!rows) rows = '<tr><td colspan="5" class="text-muted">No sessions found.</td></tr>';
      tbody.innerHTML = rows;
    }
    function loadSessions(){
      fetch('/api/v1/user/sessions')
        .then(function(r){ return r.json(); })
        .then(function(d){
          try {
            document.getElementById('account_plan').textContent = (d.plan||'free').toString().replace(/^./, function(c){ return c.toUpperCase(); });
          } catch(e){}
          renderSessions(d);
        })
        .catch(function(){
          var tbody = document.getElementById('sessions_table');
          if(tbody) tbody.innerHTML = '<tr><td colspan="5" class="text-muted">Failed to load sessions.</td></tr>';
        });
    }
    document.addEventListener('click', function(e){
      var btn = e.target.closest('.js-revoke');
      if(btn){
        var sid = btn.getAttribute('data-sid');
        fetch('/api/v1/user/sessions/revoke', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify({ sid: sid }) })
          .then(function(){ loadSessions(); window.showToast && showToast('Session logged out','warning'); });
      }
    });
    var loBtn = document.getElementById('logout_others_btn');
    if(loBtn){ loBtn.addEventListener('click', function(){
      fetch('/api/v1/user/sessions/revoke_others', { method:'POST' })
        .then(function(){ loadSessions(); window.showToast && showToast('Other sessions logged out','warning'); });
    }); }
    // init
    document.addEventListener('DOMContentLoaded', loadSessions);
  })();
</script>
