<div class="show-hero" style="background-image: url(https://image.tmdb.org/t/p/original/<%= page_data.show.backdrop_path %>)">
    <div class="container">
        <% var __hasYT = !!page_data.youtube_key; %>
        <% if (__hasYT) { %>
        <div class="embed-responsive embed-responsive-16by9">
            <iframe class="embed-responsive-item" src="https://www.youtube.com/embed/<%= page_data.youtube_key %>"
                allowfullscreen></iframe>
        </div>
        <% } else { %>
        <div class="show-hero__spacer"></div>
        <% } %>
    </div>
</div>


<div class="container">
    <!-- Show tag line + Report link on same row -->
    <div class="row align-items-center">
        <div class="col-md-9">
            <p class="m-0"><b><%= page_data.show.tagline %></b></p>
        </div>
        <div class="col-md-3 text-right">
            <a style="color:lightblue;" href="https://www.themoviedb.org/tv/<%= page_data.show.id %>">Report</a>
        </div>
    </div>

    <!-- Show Information -->
    <div class="row">
        <!-- If there is a video, show full width layout -->
        <% if (__hasYT) { %>
        <div class="col-md-12">
            <div class="row">
                <div class="col-md-10">
                    <h1><%= page_data.show.name %></h1>
                </div>
                <div class="col-md-2">
                    <div class="text-right" style="margin-top:8px;">
                        <% if (typeof user != 'undefined') { %>
                          <div class="row">
                            <div class="col-sm-4 col-md-4">
                                <i  class="far fa-check-circle fa-2x icon-white" title="Add a show that you have watched"
                                    id="add_watched_show_<%= page_data.show.id %>"
                                    onclick="showAddWatched('<%= user._id %>', '<%= page_data.show.id %>', '', '<%= user.permissions.user_private_key %>')" >
                                </i>
                                <i  class="fas fa-check-circle fa-2x icon-green" title="Remove a show from watched"
                                    id="remove_watched_show_<%= page_data.show.id %>"  
                                    onclick="showRemoveWatched('<%= user._id %>', '<%= page_data.show.id %>', '', '<%= user.permissions.user_private_key %>')">
                                </i>
                            </div>
                            <div class="col-sm-4 col-md-4">
                                <i  class="far fa-heart fa-2x icon-white" 
                                    id="add_favourited_show_<%= page_data.show.id %>" 
                                    onclick="showAddFavourited('<%= user._id %>', '<%= page_data.show.id %>', '<%= user.permissions.user_private_key %>')">
                                </i>
                                <i  class="fas fa-heart fa-2x icon-red" 
                                    id="remove_favourited_show_<%= page_data.show.id %>" 
                                    onclick="showRemoveFavourited('<%= user._id %>', '<%= page_data.show.id %>', '<%= user.permissions.user_private_key %>')">
                                </i>
                            </div>
                            <div class="col-sm-4 col-md-4">
                                <i  class="far fa-bookmark fa-2x icon-white"
                                    id="add_saved_show_<%= page_data.show.id %>" 
                                    onclick="showAddSaved('<%= user._id %>', '<%= page_data.show.id %>', '<%= user.permissions.user_private_key %>')">
                                </i>
                                <i class="fas fa-bookmark fa-2x icon-blue"
                                    id="remove_saved_show_<%= page_data.show.id %>" 
                                    onclick="showRemoveSaved('<%= user._id %>', '<%= page_data.show.id %>', '<%= user.permissions.user_private_key %>')">
                                </i>
                            </div>
                          </div>
                        <% } %>
                    </div>
                </div>
            </div>
            <!-- Modernized info section -->
            <div class="row" style="margin-top:6px;">
                <div class="col-md-12">
                    <div style="color: #fff; margin:6px 0 10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                        <% var year = (page_data.show.first_air_date||'').toString().slice(0,4); %>
                        <% if (year) { %><span style="opacity:.85;"> <%= year %> </span><% } %>
                        <% if (page_data.show.vote_average) { var __v = Number(page_data.show.vote_average||0); var __vr = Math.round(__v*2)/2; var __vrStr = (__vr % 1 === 0) ? __vr.toFixed(0) : __vr.toFixed(1); %>
                            <span style="opacity:.85;">★ <%= __vrStr %>/10</span>
                        <% } %>
                        <% if (page_data.show.number_of_seasons) { %>
                            <span style="opacity:.85;">Seasons: <%= page_data.show.number_of_seasons %></span>
                        <% } %>
                        <% if (page_data.show.number_of_episodes) { %>
                            <span style="opacity:.85;">Episodes: <%= page_data.show.number_of_episodes %></span>
                        <% } %>
                        <% if ((page_data.creators||[]).length) { %>
                            <span style="opacity:.85;">Created by 
                                <% page_data.creators.slice(0,2).forEach(function(c, i){ %>
                                    <a href="/person/<%= c.id %>" style="color: lightblue;"> <%= c.name %></a><%= (i<Math.min(1,page_data.creators.length-1)) ? ',' : '' %>
                                <% }) %>
                            </span>
                        <% } %>
                    </div>
                    <% if ((page_data.show.genres||[]).length) { %>
                    <div style="margin: 4px 0 14px;">
                        <% page_data.show.genres.forEach(function (genre, index){ %>
                            <a href="/shows?genre=<%= genre.name.toLowerCase() %>" class="badge badge-secondary" style="margin-right:6px; background:rgba(255,255,255,.08); color:#fff;"> <%= genre.name %> </a>
                        <% }); %>
                    </div>
                    <% } %>
                    <!-- Info cards (parity with movies) -->
                    <div class="info-cards">
                        <div class="row">
                            <div class="col-md-3" style="margin-bottom:10px;">
                                <div class="info-card">
                                    <div class="label">First Air Date</div>
                                    <div class="value"><%= page_data.show.first_air_date || '—' %></div>
                                </div>
                            </div>
                            <div class="col-md-3" style="margin-bottom:10px;">
                                <div class="info-card">
                                    <div class="label">Total Runtime</div>
                                    <div class="value"><span id="total_runtime_value"><%= page_data.total_runtime_text || '—' %></span>
                                      <% if (page_data.total_runtime_text) { %>
                                        <span id="total_runtime_hint" style="opacity:.7; font-size: 85%;"> (est.)</span>
                                      <% } %>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3" style="margin-bottom:10px;">
                                <div class="info-card">
                                    <div class="label">Creator</div>
                                    <div class="value">
                                        <% if ((page_data.creators||[]).length) { %>
                                            <a href="/person/<%= page_data.creators[0].id %>" style="color:#fff;"> <%= page_data.creators[0].name %></a>
                                        <% } else { %>
                                            —
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3" style="margin-bottom:10px;">
                                <div class="info-card">
                                    <div class="label">Episodes</div>
                                    <div class="value"><%= page_data.show.number_of_episodes || '—' %></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="color:#fff; opacity:.9;">
                        <%= page_data.show.overview %>
                    </div>
                </div>
            </div>
        </div>
        <% } else { %>
        <!-- If no video, keep 3-column layout -->
        <div class="col-md-12">
            <div class="row">
                <div class="col-md-12">
                    
                    <div class="d-flex justify-content-between align-items-start">
                      <h1 class="mb-0"><%= page_data.show.name %></h1>
                      <% if (typeof user != 'undefined') { %>
                      <div class="text-right" style="margin-top:8px;">
                        <div class="row" style="min-width: 220px;">
                          <div class="col-sm-4 col-md-4">
                              <i  class="far fa-check-circle fa-2x icon-white" title="Add a show that you have watched"
                                  id="add_watched_show_<%= page_data.show.id %>"
                                  onclick="showAddWatched('<%= user._id %>', '<%= page_data.show.id %>', '', '<%= user.permissions.user_private_key %>')" >
                              </i>
                              <i  class="fas fa-check-circle fa-2x icon-green" title="Remove a show from watched"
                                  id="remove_watched_show_<%= page_data.show.id %>"  
                                  onclick="showRemoveWatched('<%= user._id %>', '<%= page_data.show.id %>', '', '<%= user.permissions.user_private_key %>')">
                              </i>
                          </div>
                          <div class="col-sm-4 col-md-4">
                              <i  class="far fa-heart fa-2x icon-white" 
                                  id="add_favourited_show_<%= page_data.show.id %>" 
                                  onclick="showAddFavourited('<%= user._id %>', '<%= page_data.show.id %>', '<%= user.permissions.user_private_key %>')">
                              </i>
                              <i  class="fas fa-heart fa-2x icon-red" 
                                  id="remove_favourited_show_<%= page_data.show.id %>" 
                                  onclick="showRemoveFavourited('<%= user._id %>', '<%= page_data.show.id %>', '<%= user.permissions.user_private_key %>')">
                              </i>
                          </div>
                          <div class="col-sm-4 col-md-4">
                              <i  class="far fa-bookmark fa-2x icon-white"
                                  id="add_saved_show_<%= page_data.show.id %>" 
                                  onclick="showAddSaved('<%= user._id %>', '<%= page_data.show.id %>', '<%= user.permissions.user_private_key %>')">
                              </i>
                              <i class="fas fa-bookmark fa-2x icon-blue"
                                  id="remove_saved_show_<%= page_data.show.id %>" 
                                  onclick="showRemoveSaved('<%= user._id %>', '<%= page_data.show.id %>', '<%= user.permissions.user_private_key %>')">
                              </i>
                          </div>
                        </div>
                      </div>
                      <% } %>
                    </div>
                    
                    <div style="color: #fff; margin:6px 0 10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                        <% var year2 = (page_data.show.first_air_date||'').toString().slice(0,4); %>
                        <% if (year2) { %><span style="opacity:.85;"> <%= year2 %> </span><% } %>
                        <% if (page_data.show.vote_average) { var __v2 = Number(page_data.show.vote_average||0); var __vr2 = Math.round(__v2*2)/2; var __vrStr2 = (__vr2 % 1 === 0) ? __vr2.toFixed(0) : __vr2.toFixed(1); %>
                            <span style="opacity:.85;">★ <%= __vrStr2 %>/10</span>
                        <% } %>
                        <% if (page_data.show.number_of_seasons) { %>
                            <span style="opacity:.85;">Seasons: <%= page_data.show.number_of_seasons %></span>
                        <% } %>
                        <% if (page_data.show.number_of_episodes) { %>
                            <span style="opacity:.85;">Episodes: <%= page_data.show.number_of_episodes %></span>
                        <% } %>
                    </div>
                    <% if ((page_data.show.genres||[]).length) { %>
                    <div style="margin: 4px 0 14px;">
                        <% page_data.show.genres.forEach(function (genre, index){ %>
                            <a href="/shows?genre=<%= genre.name.toLowerCase() %>" class="badge badge-secondary" style="margin-right:6px; background:rgba(255,255,255,.08); color:#fff;"> <%= genre.name %> </a>
                        <% }); %>
                    </div>
                    <% } %>
                    <!-- Info cards -->
                    <div class="info-cards">
                        <div class="row">
                            <div class="col-md-3" style="margin-bottom:10px;">
                                <div class="info-card">
                                    <div class="label">First Air Date</div>
                                    <div class="value"><%= page_data.show.first_air_date || '—' %></div>
                                </div>
                            </div>
                            <div class="col-md-3" style="margin-bottom:10px;">
                                <div class="info-card">
                                    <div class="label">Total Runtime</div>
                                    <div class="value"><span id="total_runtime_value_novid"><%= page_data.total_runtime_text || '—' %></span>
                                      <% if (page_data.total_runtime_text) { %>
                                        <span id="total_runtime_hint_novid" style="opacity:.7; font-size: 85%;"> (est.)</span>
                                      <% } %>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3" style="margin-bottom:10px;">
                                <div class="info-card">
                                    <div class="label">Creator</div>
                                    <div class="value">
                                        <% if ((page_data.creators||[]).length) { %>
                                            <a href="/person/<%= page_data.creators[0].id %>" style="color:#fff;"> <%= page_data.creators[0].name %></a>
                                        <% } else { %>
                                            —
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3" style="margin-bottom:10px;">
                                <div class="info-card">
                                    <div class="label">Episodes</div>
                                    <div class="value"><%= page_data.show.number_of_episodes || '—' %></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="color:#fff; opacity:.9;">
                        <%= page_data.show.overview %>
                    </div>
                </div>
                <!-- right column removed; report moved next to tagline -->
            </div>
        </div>
        <% } %>
    </div>

    <% if ((page_data.cast||[]).length) { %>
    <div style="margin-top:20px;">
        <h2>Cast</h2>
        <hr>
        <div class="row cast-scroll">
            <% page_data.cast.forEach(function (p, index){ if (index < 20) { %>
                <div class="col-md-2 cast-item">
                    <a href="/person/<%= p.id %>">
                        <% if (p.profile_path) { %>
                            <img class="img-fluid" src="https://image.tmdb.org/t/p/w185/<%= p.profile_path %>" alt="<%= p.name %>" style="border-radius:6px;">
                        <% } %>
                        <div style="color:#fff; font-weight:600; margin-top:6px;"><%= p.name %></div>
                        <div style="opacity:.8; color:#ccc; font-size:12px;">
                            <%= p.character %>
                        </div>
                    </a>
                </div>
            <% } }); %>
        </div>
    </div>
    <% } %>


    <!-- Show seasons -->
    <h2>Seasons</h2>
    <hr>
    <div class="row">
        <% page_data.show.seasons.forEach(function (season, index){ %>
            <% if(season.name.toString() != "Specials") { %>
            <div class="col-md-2 image-box">
                <a href="/shows/<%= page_data.show.id %>/season/<%= season.season_number %>">
                    <img class="img-fluid image-box-hover" style="margin-bottom: 20px;" src="https://image.tmdb.org/t/p/w500/<%= season.poster_path %>"
                        alt=""
                        <% if (typeof user != 'undefined') { %>
                        onload="checkIfSeasonWatched('<%= user._id %>', '<%= page_data.show.id %>', '<%= season.season_number %>')"
                        <% } %>
                    >
                    <div class="movie-hover">
                        <h2><%= season.name %></h2>
                        <% if (typeof user != 'undefined') { %>
                        <div class="movie-actions">
                            <i class="far fa-check-circle fa-2x icon-white" id="add_watched_season_<%= page_data.show.id %>_<%= season.season_number %>"
                               onclick="event.preventDefault(); event.stopPropagation(); showSeasonComplete('<%= user._id %>', '<%= page_data.show.id %>', '<%= season.season_number %>', '<%= user.permissions.user_private_key %>')"></i>
                            <i class="fas fa-check-circle fa-2x icon-green" id="remove_watched_season_<%= page_data.show.id %>_<%= season.season_number %>"
                               onclick="event.preventDefault(); event.stopPropagation(); showSeasonUncomplete('<%= user._id %>', '<%= page_data.show.id %>', '<%= season.season_number %>', '<%= user.permissions.user_private_key %>')"></i>
                        </div>
                        <% } %>
                    </div>
                </a>
            </div>
            <% } %>
        <% }); %>
    </div>




    <!-- Similar Shows -->
    <% if ((page_data.similar||[]).length) { %>
    <div>
        <h2>Similar Shows</h2>
        <hr>
        <div class="row">
            <% page_data.similar.forEach(function (s, index){ if(index < 12) { %>
                <div class="col-md-2 image-box">
                    <a href="/shows/<%= s.id %>-<%= (s.name||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').substring(0,80) %>">
                        <img class="img-fluid image-box-hover" src="https://image.tmdb.org/t/p/w500/<%= s.poster_path %>" alt="">
                    </a>
                    <div class="movie-hover image-box-description">
                        <div class="movie-title" title="<%= s.name %>"><%= s.name %></div>
                        <div class="movie-actions">
                          <% if (typeof user != 'undefined') { %>
                          <i class="far fa-check-circle fa-2x icon-white" id="add_watched_show_<%= s.id %>" onclick="event.stopPropagation(); showAddWatched('<%= user._id %>', '<%= s.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                          <i class="fas fa-check-circle fa-2x icon-green" id="remove_watched_show_<%= s.id %>" onclick="event.stopPropagation(); showRemoveWatched('<%= user._id %>', '<%= s.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                          <i class="far fa-heart fa-2x icon-white" id="add_favourited_show_<%= s.id %>" onclick="event.stopPropagation(); showAddFavourited('<%= user._id %>', '<%= s.id %>', '<%= user.permissions.user_private_key %>'); return false;"></i>
                          <i class="fas fa-heart fa-2x icon-red" id="remove_favourited_show_<%= s.id %>" onclick="event.stopPropagation(); showRemoveFavourited('<%= user._id %>', '<%= s.id %>', '<%= user.permissions.user_private_key %>'); return false;"></i>
                          <i class="far fa-bookmark fa-2x icon-white" id="add_saved_show_<%= s.id %>" onclick="event.stopPropagation(); showAddSaved('<%= user._id %>', '<%= s.id %>', '<%= user.permissions.user_private_key %>'); return false;"></i>
                          <i class="fas fa-bookmark fa-2x icon-blue" id="remove_saved_show_<%= s.id %>" onclick="event.stopPropagation(); showRemoveSaved('<%= user._id %>', '<%= s.id %>', '<%= user.permissions.user_private_key %>'); return false;"></i>
                          <% } %>
                        </div>
                    </div>
                </div>
            <% } }); %>
        </div>

        <% if ((page_data.similar_all||[]).length > 12) { %>
        <div class="text-center" style="margin:10px 0;">
            <button id="similar_toggle_btn" class="btn btn-secondary btn-sm">Show more similar shows</button>
        </div>
        <div id="similar_more" style="display:none;">
            <div class="row">
                <% page_data.similar_all.forEach(function (s, index){ if(index >= 12) { %>
                <div class="col-md-2 image-box">
                    <a href="/shows/<%= s.id %>-<%= (s.name||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').substring(0,80) %>">
                        <img class="img-fluid image-box-hover" src="https://image.tmdb.org/t/p/w500/<%= s.poster_path %>" alt="">
                    </a>
                    <div class="movie-hover image-box-description">
                        <div class="movie-title" title="<%= s.name %>"><%= s.name %></div>
                        <div class="movie-actions">
                          <% if (typeof user != 'undefined') { %>
                          <i class="far fa-check-circle fa-2x icon-white" id="add_watched_show_<%= s.id %>" onclick="event.stopPropagation(); showAddWatched('<%= user._id %>', '<%= s.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                          <i class="fas fa-check-circle fa-2x icon-green" id="remove_watched_show_<%= s.id %>" onclick="event.stopPropagation(); showRemoveWatched('<%= user._id %>', '<%= s.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                          <i class="far fa-heart fa-2x icon-white" id="add_favourited_show_<%= s.id %>" onclick="event.stopPropagation(); showAddFavourited('<%= user._id %>', '<%= s.id %>', '<%= user.permissions.user_private_key %>'); return false;"></i>
                          <i class="fas fa-heart fa-2x icon-red" id="remove_favourited_show_<%= s.id %>" onclick="event.stopPropagation(); showRemoveFavourited('<%= user._id %>', '<%= s.id %>', '<%= user.permissions.user_private_key %>'); return false;"></i>
                          <i class="far fa-bookmark fa-2x icon-white" id="add_saved_show_<%= s.id %>" onclick="event.stopPropagation(); showAddSaved('<%= user._id %>', '<%= s.id %>', '<%= user.permissions.user_private_key %>'); return false;"></i>
                          <i class="fas fa-bookmark fa-2x icon-blue" id="remove_saved_show_<%= s.id %>" onclick="event.stopPropagation(); showRemoveSaved('<%= user._id %>', '<%= s.id %>', '<%= user.permissions.user_private_key %>'); return false;"></i>
                          <% } %>
                        </div>
                    </div>
                </div>
                <% } }); %>
            </div>
        </div>
        <% } %>
    </div>
    <% } %>
</div>

<script>
(function(){
  // Upgrade estimated runtime to precise value asynchronously
  document.addEventListener('DOMContentLoaded', function(){
    var id = <%- JSON.stringify(page_data.show && page_data.show.id) %>;
    if(!id) return;
    fetch('/api/v1/shows/' + id + '/runtime')
      .then(function(r){ return r.ok ? r.json() : null; })
      .then(function(data){
        if(!data || !data.text) return;
        var el1 = document.getElementById('total_runtime_value');
        var h1 = document.getElementById('total_runtime_hint');
        var el2 = document.getElementById('total_runtime_value_novid');
        var h2 = document.getElementById('total_runtime_hint_novid');
        [el1,el2].forEach(function(el){ if(el){ el.textContent = data.text; }});
        [h1,h2].forEach(function(h){ if(h){ h.parentNode && h.parentNode.removeChild(h); }});
      }).catch(function(){});
    try {
      <% if (typeof user != 'undefined') { %>
      checkIfFavouritedShow('<%= user._id %>', String(id));
      checkIfWatchedShow('<%= user._id %>', String(id));
      checkIfSavedShow('<%= user._id %>', String(id));

      // Initialize action state for similar shows (first 12) immediately
      (function(){
        var ids = <%- JSON.stringify((page_data.similar||[]).map(function(s){ return s && s.id; }).filter(Boolean)) %>;
        ids.forEach(function(sid){
          checkIfFavouritedShow('<%= user._id %>', String(sid));
          checkIfWatchedShow('<%= user._id %>', String(sid));
          checkIfSavedShow('<%= user._id %>', String(sid));
        });
      })();
      <% } %>
    } catch(_){}

    // Toggle for "Similar Shows" section
    try {
      var btn = document.getElementById('similar_toggle_btn');
      var more = document.getElementById('similar_more');
      if (btn && more) {
        var didInitMore = false;
        btn.addEventListener('click', function(){
          var visible = more.style.display !== 'none';
          if (visible) {
            more.style.display = 'none';
            btn.textContent = 'Show more similar shows';
          } else {
            more.style.display = '';
            btn.textContent = 'Show fewer similar shows';
            <% if (typeof user != 'undefined') { %>
            // Initialize action state for the extra items just once
            if (!didInitMore) {
              didInitMore = true;
              try {
                var moreIds = <%- JSON.stringify((page_data.similar_all||[]).slice(12).map(function(s){ return s && s.id; }).filter(Boolean)) %>;
                moreIds.forEach(function(sid){
                  checkIfFavouritedShow('<%= user._id %>', String(sid));
                  checkIfWatchedShow('<%= user._id %>', String(sid));
                  checkIfSavedShow('<%= user._id %>', String(sid));
                });
              } catch(_){}
            }
            <% } %>
          }
        });
      }
    } catch(_){}
  });
})();
</script>

<!-- Reviews -->
<div class="container" style="margin-top:18px;">
  <div class="row">
    <div class="col-md-12">
      <h2>Reviews</h2>
      <div id="show_reviews_summary" style="opacity:.85; margin-bottom:8px;"></div>
      <% if (typeof user != 'undefined') { %>
      <div class="card" style="background:#151515;border:1px solid #2a2a2a;margin-bottom:12px;border-radius:10px;">
        <div class="card-body" style="color:#ffff;">
          <h5>Your review</h5>
          <div class="form-row" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
            <input id="rv_s_title" class="form-control" placeholder="Title" style="max-width:320px;" />
            <div id="rv_s_star_widget" class="rv-stars" style="cursor:pointer; display:inline-flex; gap:4px; font-size:22px; color:#f5c518;">
              <i class="far fa-star"></i>
              <i class="far fa-star"></i>
              <i class="far fa-star"></i>
              <i class="far fa-star"></i>
              <i class="far fa-star"></i>
            </div>
            <span id="rv_s_star_label" style="opacity:.9; font-size:12px;">0.0 / 5</span>
          </div>
          <textarea id="rv_s_text" class="form-control" rows="3" placeholder="Write your review..." style="margin-top:8px;"></textarea>
          <div id="rv_s_text_count" style="opacity:.7; font-size:12px; margin-top:4px;">0/500</div>
          <button id="rv_s_submit" class="btn btn-primary" style="margin-top:8px;">Save review</button>
        </div>
      </div>
      <% } else { %>
        <div style="margin:8px 0; opacity:.85;">Please <a style="color: lightblue;" href="/login">log in</a> to write a review.</div>
      <% } %>
      <div id="show_reviews_list"></div>
    </div>
  </div>
  
  <script>
  (function(){
    var ITEM_TYPE = 'show';
    var ITEM_ID = <%- JSON.stringify(String(page_data.show && page_data.show.id || '')) %>;
    var ME = <%- JSON.stringify(typeof user != 'undefined' ? { _id: String(user._id), key: String(user.permissions && user.permissions.user_private_key || '') } : null) %>;
    var listEl = document.getElementById('show_reviews_list');
    var sumEl = document.getElementById('show_reviews_summary');
    var starWrap = document.getElementById('rv_s_star_widget');
    var starLabel = document.getElementById('rv_s_star_label');
    var starValue = 0, hoverValue = 0;
    function fmtStars(v){ var s = Number(v||0); return s.toFixed(1) + ' / 5'; }
    function drawStars(v){
      try {
        if (!starWrap) return;
        v = Math.max(0, Math.min(5, Math.round(v*2)/2));
        var html='';
        for (var i=1;i<=5;i++){
          if (v >= i) html += '<i class="fas fa-star"></i>';
          else if (v >= (i-0.5)) html += '<i class="fas fa-star-half-alt"></i>';
          else html += '<i class="far fa-star"></i>';
        }
        starWrap.innerHTML = html;
        if (starLabel) starLabel.textContent = fmtStars(v);
      } catch(_){}
    }
    function setupStars(){
      if (!starWrap) return;
      drawStars(starValue);
      function compute(e){
        var rect = starWrap.getBoundingClientRect();
        var rel = (e.clientX - rect.left) / Math.max(1, rect.width);
        var v = Math.max(0, Math.min(1, rel)) * 5; v = Math.round(v*2)/2; return v;
      }
      starWrap.addEventListener('mousemove', function(e){ hoverValue = compute(e); drawStars(hoverValue); });
      starWrap.addEventListener('mouseleave', function(){ drawStars(starValue); });
      starWrap.addEventListener('click', function(e){ starValue = compute(e); drawStars(starValue); });
    }
    function load(){
      fetch('/api/v1/reviews?type='+ITEM_TYPE+'&id='+encodeURIComponent(ITEM_ID)).then(r=>r.json()).then(function(d){
        var avg = d.average||0, count = d.count||0;
        sumEl.innerHTML = count ? ('Average rating: <b>'+fmtStars(avg)+'</b> ('+count+' reviews)') : 'No reviews yet';
        renderList(d.items||[]);
      }).catch(function(){ renderList([]); });
    }
    function esc(s){ return (s||'').replace(/[&<>"']/g, function(c){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'})[c]||c; }); }
    function renderList(items){
      listEl.innerHTML='';
      items.forEach(function(r){
        var canEdit = ME && String(r.author_id||'') === String(ME._id);
        var upCls = r.user_vote==='up' ? 'btn-success' : 'btn-outline-secondary';
        var downCls = r.user_vote==='down' ? 'btn-danger' : 'btn-outline-secondary';
        var card = document.createElement('div');
        card.className = 'card';
        card.style.cssText = 'background:#151515;border:1px solid #2a2a2a;margin-bottom:12px;border-radius:10px;';
        card.innerHTML = '<div class="card-body" style="color:#ffff;">'
          + '<div style="display:flex; align-items:center; gap:10px;">'
          +   '<img src="'+esc(r.user_avatar||'/static/style/img/standard/standard_avatar.png')+'" style="width:28px;height:28px;border-radius:50%;object-fit:cover;">'
          +   '<div style="flex:1;">'
          +     '<div><a href="'+esc(r.user_link||'#')+'" style="color:lightblue;">'+esc(r.username||'user')+'</a></div>'
          +     '<div style="opacity:.8; font-size:12px;">'+new Date(r.created_at).toLocaleString()+'</div>'
          +   '</div>'
          +   '<div><span class="badge badge-info">'+fmtStars(r.stars)+'</span></div>'
          + '</div>'
          + '<h5 style="margin-top:8px;">'+esc(r.title||'')+'</h5>'
          + '<div>'+(esc(r.text||'').replace(/\n/g,'<br>'))+'</div>'
          + '<div style="margin-top:8px; display:flex; gap:8px; align-items:center;">'
          +   (canEdit ? '<button class="btn btn-sm btn-secondary js-edit" data-id="'+r._id+'">Edit</button>' : '')
          +   (canEdit ? '<button class="btn btn-sm btn-outline-danger js-del" data-id="'+r._id+'">Delete</button>' : '')
          +   '<div class="btn-group btn-group-sm" role="group">'
          +     '<button class="btn '+upCls+' js-vote" data-id="'+r._id+'" data-action="up"><i class="fas fa-arrow-up"></i> <span class="js-up">'+(r.upvote_count||0)+'</span></button>'
          +     '<button class="btn '+downCls+' js-vote" data-id="'+r._id+'" data-action="down"><i class="fas fa-arrow-down"></i> <span class="js-down">'+(r.downvote_count||0)+'</span></button>'
          +   '</div>'
          + '</div>'
          + '<div class="mt-2">'
          +   '<button class="btn btn-sm btn-outline-secondary js-show-cmt" data-id="'+r._id+'">Comments</button>'
          +   '<button class="btn btn-sm btn-outline-danger js-report-review" data-id="'+r._id+'" data-uid="'+(r.author_id||'')+'">Report</button>'
          +   '<div class="js-cmt-wrap" id="cmt_'+r._id+'" style="display:none; margin-top:8px;"></div>'
          + '</div>'
          + '</div>';
        listEl.appendChild(card);
        // Auto-load comments by default
        try {
          var wrap = card.querySelector('#cmt_'+r._id+'');
          if (wrap) { loadComments(r._id, wrap); }
        } catch(_){}
      });
      bindListHandlers();
    }
    function bindListHandlers(){
      listEl.querySelectorAll('.js-vote').forEach(function(btn){
        btn.onclick = function(){
          if(!ME) return alert('Please log in to vote.');
          var id = this.getAttribute('data-id');
          var act = this.getAttribute('data-action');
          fetch('/api/v1/reviews/'+id+'/vote', {
            method: 'POST', headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ user_id: ME._id, user_key: ME.key, vote: act })
          }).then(r=>r.json()).then(function(){ load(); });
        };
      });
      listEl.querySelectorAll('.js-edit').forEach(function(btn){
        btn.onclick = function(){
          var id = this.getAttribute('data-id');
          var t = prompt('New title:'); if(t==null) return;
          var s = prompt('New stars (0-5, halves ok):'); if(s==null) return;
          var x = prompt('New text:'); if(x==null) return;
          fetch('/api/v1/reviews/'+id+'/edit', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: ME._id, user_key: ME.key, title: t, stars: Number(s||0), text: x }) }).then(()=>load());
        };
      });
      listEl.querySelectorAll('.js-del').forEach(function(btn){
        btn.onclick = function(){
          if(!confirm('Delete this review?')) return;
          var id = this.getAttribute('data-id');
          fetch('/api/v1/reviews/'+id+'/delete', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: ME._id, user_key: ME.key }) }).then(()=>load());
        };
      });
      listEl.querySelectorAll('.js-show-cmt').forEach(function(btn){
        btn.onclick = function(){
          var id = this.getAttribute('data-id');
          var wrap = document.getElementById('cmt_'+id);
          if (wrap.getAttribute('data-loaded')==='1') { wrap.style.display = (wrap.style.display==='none'?'block':'none'); return; }
          loadComments(id, wrap);
        };
      });
    }
    function loadComments(rid, wrap){
      wrap.innerHTML = '<div>Loading...</div>';
      fetch('/api/v1/reviews/'+rid).then(r=>r.json()).then(function(d){
        var r = d.review; if(!r){ wrap.innerHTML='<div>No comments</div>'; return; }
        var comments = Array.isArray(r.comments)?r.comments:[];
        var out = '';
        comments.forEach(function(c){
          out += '<div style="border:1px solid #2a2a2a; background:#101010; padding:8px; border-radius:8px; margin-bottom:6px;">'
              + '<div style="opacity:.85; font-size:12px;">'+(c.username||'')+' • '+new Date(c.created_at).toLocaleString()+'</div>'
              + '<div>'+(String(c.message||'').replace(/\n/g,'<br>'))+'</div>'
              + '</div>';
        });
        if (ME) {
          out += '<div class="card" style="background:#151515;border:1px solid #2a2a2a;border-radius:10px;">'
            + '<div class="card-body" style="color:#ffff;">'
            + '<textarea class="form-control" id="cmt_new_'+rid+'" rows="2" placeholder="Add a comment..."></textarea>'
            + '<button class="btn btn-primary" style="margin-top:6px;" data-id="'+rid+'" id="cmt_send_'+rid+'">Post</button>'
            + '</div></div>';
        }
        wrap.innerHTML = out || '<div>No comments yet.</div>';
        wrap.style.display = 'block';
        wrap.setAttribute('data-loaded','1');
        if (ME) {
          var btn = document.getElementById('cmt_send_'+rid);
          btn && (btn.onclick = function(){
            var ta = document.getElementById('cmt_new_'+rid);
            var msg = (ta && ta.value||'').trim(); if(!msg) return;
            fetch('/api/v1/reviews/'+rid+'/comment', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: ME._id, user_key: ME.key, message: msg }) }).then(function(){ loadComments(rid, wrap); });
          });
          // Normalize deleted comment display
          try {
            var nodes = wrap.children || [];
            for (var j=0; j<comments.length; j++){
              var cc = comments[j]; var el = nodes[j]; if (!cc || !el) continue;
              if (cc.deleted && el && el.children && el.children[1]) { el.children[1].innerHTML = '<em style="opacity:.8;">-deleted-</em>'; }
            }
          } catch(_){}
          // Append action controls for each comment (edit/delete/report)
          try {
            var blocks = Array.prototype.slice.call(wrap.children || []).filter(function(el){ return el && el.tagName === 'DIV' && el.querySelector && !el.querySelector('#cmt_new_'+rid); });
            blocks.forEach(function(el, idx){
              var c = (comments||[])[idx]; if(!c) return;
              var isAdmin = <%- JSON.stringify(typeof user != 'undefined' && user.permissions && user.permissions.level && user.permissions.level.admin) %>;
              var isOwner = <%- JSON.stringify(typeof user != 'undefined' ? String(user._id) : '') %> === String(c.user_id||'');
              if (c.deleted) return;
              var actions = document.createElement('div');
              actions.style.cssText = 'margin-top:6px; display:flex; gap:6px; flex-wrap:wrap;';
              if (isOwner){ var e=document.createElement('button'); e.className='btn btn-sm btn-outline-secondary'; e.textContent='Edit'; e.onclick=function(){ var txt=prompt('Edit comment:'); if(txt==null) return; fetch('/api/v1/reviews/'+rid+'/comment/'+c._id+'/edit', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: ME._id, user_key: ME.key, message: txt })}).then(function(){ loadComments(rid, wrap); }); }; actions.appendChild(e); }
              if (isOwner || isAdmin){ var d=document.createElement('button'); d.className='btn btn-sm btn-outline-danger'; d.textContent='Delete'; d.onclick=function(){ fetch('/api/v1/reviews/'+rid+'/comment/'+c._id+'/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: ME._id, user_key: ME.key, mode: 'soft' })}).then(function(){ loadComments(rid, wrap); }); }; actions.appendChild(d); }
              if (isAdmin){ var hd=document.createElement('button'); hd.className='btn btn-sm btn-danger'; hd.textContent='Hard delete'; hd.onclick=function(){ if(!confirm('Hard delete?')) return; fetch('/api/v1/reviews/'+rid+'/comment/'+c._id+'/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: ME._id, user_key: ME.key, mode: 'hard' })}).then(function(){ loadComments(rid, wrap); }); }; actions.appendChild(hd); }
              var rep=document.createElement('button'); rep.className='btn btn-sm btn-outline-warning'; rep.textContent='Report'; rep.onclick=function(){ var reason=prompt('Reason for report?'); if(reason==null) return; fetch('/api/v1/reports', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ reported_user_id: c.user_id, reason: reason, context: 'comment', meta: { review_id: rid, comment_id: c._id } })}).then(function(){ alert('Reported'); }); }; actions.appendChild(rep);
              el.appendChild(actions);
            });
          } catch(_){}
        }
      });
    }
    if (ME) {
      var btn = document.getElementById('rv_s_submit');
      btn && (btn.onclick = function(){
        var t = document.getElementById('rv_s_title').value||'';
        var x = document.getElementById('rv_s_text').value||'';
        var maxLen = 500; if (x.length > maxLen){ alert('Review is too long ('+x.length+'/'+maxLen+').'); return; }
        fetch('/api/v1/reviews', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: ME._id, user_key: ME.key, type: ITEM_TYPE, id: ITEM_ID, title: t, stars: starValue, text: x }) }).then(function(){ load(); });
      });
    }
    setupStars();
    // live char counter (UI hint; server enforces)
    try {
      var maxLen = 500; var ta = document.getElementById('rv_s_text'); var ct = document.getElementById('rv_s_text_count');
      if (ta && ct){ ta.addEventListener('input', function(){ var n=(ta.value||'').length; ct.textContent = n+'/'+maxLen; ct.style.color = (n>maxLen)?'#ff6b6b':'#aaa'; }); }
    } catch(_){}
    // global report handler for review items
    document.addEventListener('click', function(e){
      var el = e.target.closest('.js-report-review');
      if(!el) return;
      var rid = el.getAttribute('data-id');
      var uid = el.getAttribute('data-uid');
      var reason = prompt('Reason for report?');
      if(reason==null) return;
      fetch('/api/v1/reports', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ reported_user_id: uid, reason: reason, context: 'review', meta: { review_id: rid } })}).then(function(){ alert('Reported'); });
    });
    document.addEventListener('DOMContentLoaded', load);
  })();
  </script>
</div>
