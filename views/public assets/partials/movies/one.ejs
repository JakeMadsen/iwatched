<div style="background-color: dimgrey; background-repeat: no-repeat; background-size: cover; background-image: url(https://image.tmdb.org/t/p/original/<%= page_data.movie.backdrop_path %>)">
    <div class="container">
        <% if (page_data.movie_videos.length != '0' ) { %>
        <div class="embed-responsive embed-responsive-16by9">
            <iframe class="embed-responsive-item" src="https://www.youtube.com/embed/<%= page_data.movie_videos[0].key %>"
                allowfullscreen></iframe>
        </div>
        <% } %>
    </div>
</div>


<div class="container">
    <!-- Movie tag line -->
    <div class="row">
        <div class="col-md-1">

        </div>
        <div class="col-md-10">
            <p class="text-center">
                <b><%= page_data.movie.tagline %></b>
            </p>
        </div>
        <div class="col-md-1">
            <a style="float:right; color:lightblue;" href="https://www.themoviedb.org/movie/<%= page_data.movie.id %>">Report</a>
        </div>

    </div>

    <!-- Movie Information -->
    <div class="row">
        <!-- If there is a video, show full width layout -->
        <% if (page_data.movie_videos.length != '0' ) { %>
        
        <div class="col-md-12">
            <div class="row">
                <div class="col-md-10">
                    <h1><%= page_data.movie.title %></h1>
                </div>
                <div class="col-md-2">
                    <% if(typeof user != 'undefined') { %>
                        <div class="row">
                            <div class="col-sm-4 col-md-4">
                                <i  class="far fa-check-circle fa-2x icon-white" title="Add a movie that you have watched"
                                    id="add_watched_movie_<%= page_data.movie.id %>"
                                    onclick="movieAddWatched('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')" >
                                </i>
                                <i  class="fas fa-check-circle fa-2x icon-green" title="Remove a movie from watched"
                                    id="remove_watched_movie_<%= page_data.movie.id %>"  
                                    onclick="movieRemoveWatched('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')">
                                </i>
                            </div>
                            <div class="col-sm-4 col-md-4">
                                <i  class="far fa-heart fa-2x icon-white" 
                                    id="add_favourited_movie_<%= page_data.movie.id %>" 
                                    onclick="movieAddFavourited('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')">
                                </i>
                                <i  class="fas fa-heart fa-2x icon-red" 
                                    id="remove_favourited_movie_<%= page_data.movie.id %>" 
                                    onclick="movieRemoveFavourited('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')">
                                </i>
                            </div>
                            <div class="col-sm-4 col-md-4">
                                <i  class="far fa-bookmark fa-2x icon-white"
                                    id="add_saved_movie_<%= page_data.movie.id %>" 
                                    onclick="movieAddSaved('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')">
                                </i>
                                <i class="fas fa-bookmark fa-2x icon-blue"
                                    id="remove_saved_movie_<%= page_data.movie.id %>" 
                                    onclick="movieRemoveSaved('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')">
                                </i>
                            </div>
                        </div>
                    <% } %>
                </div>
            </div>
            
            <!-- Modernized info section -->
            <div class="row" style="margin-top:6px;">
                <div class="col-md-12">
                    <div style="color: #fff; margin:6px 0 10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                        <% var year = (page_data.movie.release_date||'').toString().slice(0,4); %>
                        <% if (year) { %><span style="opacity:.85;"> <%= year %> </span><% } %>
                        <% if (page_data.movie.vote_average) { var __v = Number(page_data.movie.vote_average||0); var __vr = Math.round(__v*2)/2; var __vrStr = (__vr % 1 === 0) ? __vr.toFixed(0) : __vr.toFixed(1); %>
                            <span style="opacity:.85;">�</span>
                            <span style="opacity:.85;"> <i class="fas fa-star" style="color:#f5c518;"></i> <%= __vrStr %>/10</span>
                        <% } %>
                        <!-- <span style="opacity:.85;">•</span> -->
                        <!-- <span style="opacity:.85;"> <%= page_data.runtime %> </span> -->
                    </div>

                    <div style="margin-bottom:8px;">
                        <% (page_data.movie.genres||[]).forEach(function(genre){ %>
                            <a href="/movies?genre=<%= genre.name.toLowerCase() %>" class="badge badge-secondary" style="margin-right:6px; background:rgba(255,255,255,.08); color:#fff;"> <%= genre.name %> </a>
                        <% }); %>
                    </div>

                    <% if (page_data.movie.overview) { %>
                    <p style="font-size:16px; line-height:1.6; opacity:.95; max-width:980px;">
                        <%= page_data.movie.overview %>
                    </p>
                    <% } %>

                    <!-- New responsive info cards -->
                    <div class="info-cards">
                        <div class="row no-gutters">
                            <% if (page_data.movie.release_date) { %>
                            <div class="col-12 col-sm-6 col-md-3 p-1">
                            <div class="info-card">
                                <div class="label">Release Date</div>
                                <div class="value"><%= new Date(page_data.movie.release_date).toLocaleDateString() %></div>
                            </div>
                            </div>
                            <% } %>
                            <div class="col-12 col-sm-6 col-md-3 p-1">
                            <div class="info-card">
                                <div class="label">Runtime</div>
                                <div class="value"><%= page_data.runtime %></div>
                            </div>
                            </div>
                            <% if ((page_data.directors||[]).length) { var d0 = page_data.directors[0]; %>
                            <div class="col-12 col-sm-6 col-md-3 p-1">
                            <div class="info-card">
                                <div class="label">Director</div>
                                <div class="value"><a href="/person/<%= d0.id %>" style="color:#fff; text-decoration:none;"> <%= d0.name %> </a></div>
                            </div>
                            </div>
                            <% } %>
                            <% if (page_data.movie.budget) { %>
                            <div class="col-12 col-sm-6 col-md-3 p-1">
                            <div class="info-card">
                                <div class="label">Budget</div>
                                <div class="value">$<%= (page_data.movie.budget||0).toLocaleString('en-US') %></div>
                            </div>
                            </div>
                            <% } %>
                        </div>
                    </div>

                </div>
            </div>

        </div>
        
        <% } else { %>
            <!-- No video available, show normal layout -->

            <div class="col-md-9">
                <div class="row">
                    <div class="col-md-10">
                        <h1><%= page_data.movie.title %></h1>
                    </div>
                    <div class="col-md-2">
                        <% if(typeof user != 'undefined') { %>
                            <div class="row">
                                <div class="col-sm-4 col-md-4">
                                    <i  class="far fa-check-circle fa-2x icon-white" title="Add a movie that you have watched"
                                        id="add_watched_movie_<%= page_data.movie.id %>"
                                        onclick="movieAddWatched('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')" >
                                    </i>
                                    <i  class="fas fa-check-circle fa-2x icon-green" title="Remove a movie from watched"
                                        id="remove_watched_movie_<%= page_data.movie.id %>"  
                                        onclick="movieRemoveWatched('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')">
                                    </i>
                                </div>
                                <div class="col-sm-4 col-md-4">
                                    <i  class="far fa-heart fa-2x icon-white" 
                                        id="add_favourited_movie_<%= page_data.movie.id %>" 
                                        onclick="movieAddFavourited('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')">
                                    </i>
                                    <i  class="fas fa-heart fa-2x icon-red" 
                                        id="remove_favourited_movie_<%= page_data.movie.id %>" 
                                        onclick="movieRemoveFavourited('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')">
                                    </i>
                                </div>
                                <div class="col-sm-4 col-md-4">
                                    <i  class="far fa-bookmark fa-2x icon-white"
                                        id="add_saved_movie_<%= page_data.movie.id %>" 
                                        onclick="movieAddSaved('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')">
                                    </i>
                                    <i class="fas fa-bookmark fa-2x icon-blue"
                                        id="remove_saved_movie_<%= page_data.movie.id %>" 
                                        onclick="movieRemoveSaved('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')">
                                    </i>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </div>
                
                <!-- Modernized info section -->
                <div class="row" style="margin-top:6px;">
                    <div class="col-md-12">
                        <div style="color: #fff; margin:6px 0 10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                            <% var year = (page_data.movie.release_date||'').toString().slice(0,4); %>
                            <% if (year) { %><span style="opacity:.85;"> <%= year %> </span><% } %>
                            <% if (page_data.movie.vote_average) { var __v = Number(page_data.movie.vote_average||0); var __vr = Math.round(__v*2)/2; var __vrStr = (__vr % 1 === 0) ? __vr.toFixed(0) : __vr.toFixed(1); %>
                            <span style="opacity:.85;">�</span>
                            <span style="opacity:.85;"> <i class="fas fa-star" style="color:#f5c518;"></i> <%= __vrStr %>/10</span>
                        <% } %>
                            <!-- <span style="opacity:.85;">•</span> -->
                            <!-- <span style="opacity:.85;"> <%= page_data.runtime %> </span> -->
                        </div>

                        <div style="margin-bottom:8px;">
                            <% (page_data.movie.genres||[]).forEach(function(genre){ %>
                                <a href="/movies?genre=<%= genre.name.toLowerCase() %>" class="badge badge-secondary" style="margin-right:6px; background:rgba(255,255,255,.08); color:#fff;"> <%= genre.name %> </a>
                            <% }); %>
                        </div>

                        <% if (page_data.movie.overview) { %>
                        <p style="font-size:16px; line-height:1.6; opacity:.95; max-width:980px;">
                            <%= page_data.movie.overview %>
                        </p>
                        <% } %>

                        <!-- New responsive info cards -->
                        <div class="info-cards">
                            <div class="row no-gutters">
                                <% if (page_data.movie.release_date) { %>
                                <div class="col-12 col-sm-6 col-md-3 p-1">
                                <div class="info-card">
                                    <div class="label">Release Date</div>
                                    <div class="value"><%= new Date(page_data.movie.release_date).toLocaleDateString() %></div>
                                </div>
                                </div>
                                <% } %>
                                <div class="col-12 col-sm-6 col-md-3 p-1">
                                <div class="info-card">
                                    <div class="label">Runtime</div>
                                    <div class="value"><%= page_data.runtime %></div>
                                </div>
                                </div>
                                <% if ((page_data.directors||[]).length) { var d0 = page_data.directors[0]; %>
                                <div class="col-12 col-sm-6 col-md-3 p-1">
                                <div class="info-card">
                                    <div class="label">Director</div>
                                    <div class="value"><a href="/person/<%= d0.id %>" style="color:#fff; text-decoration:none;"> <%= d0.name %> </a></div>
                                </div>
                                </div>
                                <% } %>
                                <% if (page_data.movie.budget) { %>
                                <div class="col-12 col-sm-6 col-md-3 p-1">
                                <div class="info-card">
                                    <div class="label">Budget</div>
                                    <div class="value">$<%= (page_data.movie.budget||0).toLocaleString('en-US') %></div>
                                </div>
                                </div>
                                <% } %>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <img class="img-fluid" src="https://image.tmdb.org/t/p/w500/<%= page_data.movie.poster_path %>" alt="">
            </div>
        <% } %>
    
        
    </div>



    <% if ((page_data.cast||[]).length) { %>
    <div>
        <style>
            .cast-row{overflow-x:auto; white-space:nowrap; flex-wrap:nowrap; padding-bottom:8px;}
            .cast-row::-webkit-scrollbar{height:6px;}
            .cast-row::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.25); border-radius:6px; }
            .cast-row{scrollbar-width:thin; scrollbar-color: rgba(255,255,255,.25) transparent;}
        </style>
        <h4 style="margin-bottom:8px; color:#fff;">Cast</h4>

        <div class="row cast-row">
            <% page_data.cast.forEach(function (p, index){ if (index < 20) { %>
                <div class="col-md-2" style="display:inline-block; float:none;">
                    <a href="/person/<%= p.id %>">
                        <% if (p.profile_path) { %>
                            <img class="img-fluid" src="https://image.tmdb.org/t/p/w185/<%= p.profile_path %>" alt="<%= p.name %>" style="border-radius:6px;">
                        <% } %>
                        <div style="color:#fff; font-weight:600; margin-top:6px;"><%= p.name %></div>
                        <div style="opacity:.8; color:#ccc; font-size:12px;">
                            <%= p.character %>
                        </div>
                    </a>
                </div>
            <% } }); %>
        </div>
    </div>
    <% } %>
    
    <!-- Similar Movies -->
    <% if ((page_data.similar||[]).length) { %>
    <div>
        <h2>Similar Movies</h2>
        <hr>

        <div class="row">
            <% page_data.similar.forEach(function (m, index){ if (index < 12) { %>
            <div class="col-md-2 image-box">
                <a href="/movies/<%= m.id %>-<%= (m.title||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').substring(0,80) %>">
                    <img class="img-fluid image-box-hover" src="https://image.tmdb.org/t/p/w500/<%= m.poster_path %>" alt="">
                </a>
                <div class="movie-hover image-box-description">
                    <div class="movie-title" title="<%= m.title %>"><%= m.title %></div>
                    <% if (typeof user != 'undefined') { %>
                    <div class="movie-actions">
                        <i class="far fa-check-circle fa-2x icon-white" id="add_watched_movie_<%= m.id %>" onclick="event.stopPropagation(); movieAddWatched('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                        <i class="fas fa-check-circle fa-2x icon-green" id="remove_watched_movie_<%= m.id %>" onclick="event.stopPropagation(); movieRemoveWatched('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                        <i class="far fa-heart fa-2x icon-white" id="add_favourited_movie_<%= m.id %>" onclick="event.stopPropagation(); movieAddFavourited('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                        <i class="fas fa-heart fa-2x icon-red" id="remove_favourited_movie_<%= m.id %>" onclick="event.stopPropagation(); movieRemoveFavourited('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                        <i class="far fa-bookmark fa-2x icon-white" id="add_saved_movie_<%= m.id %>" onclick="event.stopPropagation(); movieAddSaved('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                        <i class="fas fa-bookmark fa-2x icon-blue" id="remove_saved_movie_<%= m.id %>" onclick="event.stopPropagation(); movieRemoveSaved('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                    </div>
                    <% } %>
                </div>
            </div>
            <% } }); %>
        </div>

        <% if ((page_data.similar_all||[]).length > 12) { %>
        <div class="text-center" style="margin:10px 0;">
            <button id="movie_similar_toggle_btn" class="btn btn-secondary btn-sm">Show more similar movies</button>
        </div>
        <div id="movie_similar_more" style="display:none;">
            <div class="row">
                <% page_data.similar_all.forEach(function (m, index){ if (index >= 12) { %>
                <div class="col-md-2 image-box">
                    <a href="/movies/<%= m.id %>-<%= (m.title||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').substring(0,80) %>">
                        <img class="img-fluid image-box-hover" src="https://image.tmdb.org/t/p/w500/<%= m.poster_path %>" alt="">
                    </a>
                    <div class="movie-hover image-box-description">
                        <div class="movie-title" title="<%= m.title %>"><%= m.title %></div>
                        <% if (typeof user != 'undefined') { %>
                        <div class="movie-actions">
                            <i class="far fa-check-circle fa-2x icon-white" id="add_watched_movie_<%= m.id %>" onclick="event.stopPropagation(); movieAddWatched('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                            <i class="fas fa-check-circle fa-2x icon-green" id="remove_watched_movie_<%= m.id %>" onclick="event.stopPropagation(); movieRemoveWatched('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                            <i class="far fa-heart fa-2x icon-white" id="add_favourited_movie_<%= m.id %>" onclick="event.stopPropagation(); movieAddFavourited('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                            <i class="fas fa-heart fa-2x icon-red" id="remove_favourited_movie_<%= m.id %>" onclick="event.stopPropagation(); movieRemoveFavourited('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                            <i class="far fa-bookmark fa-2x icon-white" id="add_saved_movie_<%= m.id %>" onclick="event.stopPropagation(); movieAddSaved('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                            <i class="fas fa-bookmark fa-2x icon-blue" id="remove_saved_movie_<%= m.id %>" onclick="event.stopPropagation(); movieRemoveSaved('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                        </div>
                        <% } %>
                    </div>
                </div>
                <% } }); %>
            </div>
        </div>
        <% } %>
    </div>
    <% } %>
    
    </div>

<script>
(function(){
  document.addEventListener('DOMContentLoaded', function(){
    try {
      <% if (typeof user != 'undefined') { %>
      // Initialize main movie quick-action state
      checkIfWatched('<%= user._id %>', String(<%= page_data.movie.id %>));
      checkIfFavourited('<%= user._id %>', String(<%= page_data.movie.id %>));
      checkIfSaved('<%= user._id %>', String(<%= page_data.movie.id %>));

      // Initialize first 12 similar movies
      (function(){
        var ids = <%- JSON.stringify((page_data.similar||[]).map(function(m){ return m && m.id; }).filter(Boolean)) %>;
        ids.forEach(function(mid){
          checkIfWatched('<%= user._id %>', String(mid));
          checkIfFavourited('<%= user._id %>', String(mid));
          checkIfSaved('<%= user._id %>', String(mid));
        });
      })();
      <% } %>
    } catch(_){}

    // Toggle for "Similar Movies" section
    try {
      var btn = document.getElementById('movie_similar_toggle_btn');
      var more = document.getElementById('movie_similar_more');
      if (btn && more) {
        var didInitMore = false;
        btn.addEventListener('click', function(){
          var visible = more.style.display !== 'none';
          if (visible) {
            more.style.display = 'none';
            btn.textContent = 'Show more similar movies';
          } else {
            more.style.display = '';
            btn.textContent = 'Show fewer similar movies';
            <% if (typeof user != 'undefined') { %>
            if (!didInitMore) {
              didInitMore = true;
              try {
                var moreIds = <%- JSON.stringify((page_data.similar_all||[]).slice(12).map(function(m){ return m && m.id; }).filter(Boolean)) %>;
                moreIds.forEach(function(mid){
                  checkIfWatched('<%= user._id %>', String(mid));
                  checkIfFavourited('<%= user._id %>', String(mid));
                  checkIfSaved('<%= user._id %>', String(mid));
                });
              } catch(_){}
            }
            <% } %>
          }
        });
      }
    } catch(_){}
  });
})();
</script>

