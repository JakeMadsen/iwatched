<div style="background-color: dimgrey; background-repeat: no-repeat; background-size: cover; background-image: url(https://image.tmdb.org/t/p/original/<%= page_data.movie.backdrop_path %>)">
    <div class="container">
        <% if (page_data.movie_videos.length != '0' ) { %>
        <div class="embed-responsive embed-responsive-16by9">
            <iframe class="embed-responsive-item" src="https://www.youtube.com/embed/<%= page_data.movie_videos[0].key %>"
                allowfullscreen></iframe>
        </div>
        <% } %>
    </div>
</div>


<div class="container">
    <!-- Movie tag line -->
    <div class="row">
        <div class="col-md-1">

        </div>
        <div class="col-md-10">
            <p class="text-center">
                <b><%= page_data.movie.tagline %></b>
            </p>
        </div>
        <div class="col-md-1">
            <a style="float:right; color:lightblue;" href="https://www.themoviedb.org/movie/<%= page_data.movie.id %>">Report</a>
        </div>

    </div>

    <!-- Movie Information -->
    <div class="row">
        <!-- If there is a video, show full width layout -->
        <% if (page_data.movie_videos.length != '0' ) { %>
        
        <div class="col-md-12">
            <div class="row">
                <div class="col-md-10">
                    <h1><%= page_data.movie.title %></h1>
                </div>
                <div class="col-md-2">
                    <% if(typeof user != 'undefined') { %>
                        <div class="row">
                            <div class="col-sm-4 col-md-4">
                                <i  class="far fa-check-circle fa-2x icon-white" title="Add a movie that you have watched"
                                    id="add_watched_movie_<%= page_data.movie.id %>"
                                    onclick="movieAddWatched('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')" >
                                </i>
                                <i  class="fas fa-check-circle fa-2x icon-green" title="Remove a movie from watched"
                                    id="remove_watched_movie_<%= page_data.movie.id %>"  
                                    onclick="movieRemoveWatched('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')">
                                </i>
                            </div>
                            <div class="col-sm-4 col-md-4">
                                <i  class="far fa-heart fa-2x icon-white" 
                                    id="add_favourited_movie_<%= page_data.movie.id %>" 
                                    onclick="movieAddFavourited('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')">
                                </i>
                                <i  class="fas fa-heart fa-2x icon-red" 
                                    id="remove_favourited_movie_<%= page_data.movie.id %>" 
                                    onclick="movieRemoveFavourited('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')">
                                </i>
                            </div>
                            <div class="col-sm-4 col-md-4">
                                <i  class="far fa-bookmark fa-2x icon-white"
                                    id="add_saved_movie_<%= page_data.movie.id %>" 
                                    onclick="movieAddSaved('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')">
                                </i>
                                <i class="fas fa-bookmark fa-2x icon-blue"
                                    id="remove_saved_movie_<%= page_data.movie.id %>" 
                                    onclick="movieRemoveSaved('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')">
                                </i>
                            </div>
                        </div>
                    <% } %>
                </div>
            </div>
            
            <!-- Modernized info section -->
            <div class="row" style="margin-top:6px;">
                <div class="col-md-12">
                    <div style="color: #fff; margin:6px 0 10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                        <% var year = (page_data.movie.release_date||'').toString().slice(0,4); %>
                        <% if (year) { %><span style="opacity:.85;"> <%= year %> </span><% } %>
                        <% if (page_data.movie.vote_average) { var __v = Number(page_data.movie.vote_average||0); var __vr = Math.round(__v*2)/2; var __vrStr = (__vr % 1 === 0) ? __vr.toFixed(0) : __vr.toFixed(1); %>
                            <span style="opacity:.85;">�</span>
                            <span style="opacity:.85;"> <i class="fas fa-star" style="color:#f5c518;"></i> <%= __vrStr %>/10</span>
                        <% } %>
                        <!-- <span style="opacity:.85;">•</span> -->
                        <!-- <span style="opacity:.85;"> <%= page_data.runtime %> </span> -->
                    </div>

                    <div style="margin-bottom:8px;">
                        <% (page_data.movie.genres||[]).forEach(function(genre){ %>
                            <a href="/movies?genre=<%= genre.name.toLowerCase() %>" class="badge badge-secondary" style="margin-right:6px; background:rgba(255,255,255,.08); color:#fff;"> <%= genre.name %> </a>
                        <% }); %>
                    </div>

                    <% if (page_data.movie.overview) { %>
                    <p style="font-size:16px; line-height:1.6; opacity:.95; max-width:980px;">
                        <%= page_data.movie.overview %>
                    </p>
                    <% } %>

                    <!-- New responsive info cards -->
                    <div class="info-cards">
                        <div class="row no-gutters">
                            <% if (page_data.movie.release_date) { %>
                            <div class="col-12 col-sm-6 col-md-3 p-1">
                            <div class="info-card">
                                <div class="label">Release Date</div>
                                <div class="value"><%= new Date(page_data.movie.release_date).toLocaleDateString() %></div>
                            </div>
                            </div>
                            <% } %>
                            <div class="col-12 col-sm-6 col-md-3 p-1">
                            <div class="info-card">
                                <div class="label">Runtime</div>
                                <div class="value"><%= page_data.runtime %></div>
                            </div>
                            </div>
                            <% if ((page_data.directors||[]).length) { var d0 = page_data.directors[0]; %>
                            <div class="col-12 col-sm-6 col-md-3 p-1">
                            <div class="info-card">
                                <div class="label">Director</div>
                                <div class="value"><a href="/person/<%= d0.id %>" style="color:#fff; text-decoration:none;"> <%= d0.name %> </a></div>
                            </div>
                            </div>
                            <% } %>
                            <% if (page_data.movie.budget) { %>
                            <div class="col-12 col-sm-6 col-md-3 p-1">
                            <div class="info-card">
                                <div class="label">Budget</div>
                                <div class="value">$<%= (page_data.movie.budget||0).toLocaleString('en-US') %></div>
                            </div>
                            </div>
                            <% } %>
                        </div>
                    </div>

                </div>
            </div>

        </div>
        
        <% } else { %>
            <!-- No video available, show normal layout -->

            <div class="col-md-9">
                <div class="row">
                    <div class="col-md-10">
                        <h1><%= page_data.movie.title %></h1>
                    </div>
                    <div class="col-md-2">
                        <% if(typeof user != 'undefined') { %>
                            <div class="row">
                                <div class="col-sm-4 col-md-4">
                                    <i  class="far fa-check-circle fa-2x icon-white" title="Add a movie that you have watched"
                                        id="add_watched_movie_<%= page_data.movie.id %>"
                                        onclick="movieAddWatched('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')" >
                                    </i>
                                    <i  class="fas fa-check-circle fa-2x icon-green" title="Remove a movie from watched"
                                        id="remove_watched_movie_<%= page_data.movie.id %>"  
                                        onclick="movieRemoveWatched('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')">
                                    </i>
                                </div>
                                <div class="col-sm-4 col-md-4">
                                    <i  class="far fa-heart fa-2x icon-white" 
                                        id="add_favourited_movie_<%= page_data.movie.id %>" 
                                        onclick="movieAddFavourited('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')">
                                    </i>
                                    <i  class="fas fa-heart fa-2x icon-red" 
                                        id="remove_favourited_movie_<%= page_data.movie.id %>" 
                                        onclick="movieRemoveFavourited('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')">
                                    </i>
                                </div>
                                <div class="col-sm-4 col-md-4">
                                    <i  class="far fa-bookmark fa-2x icon-white"
                                        id="add_saved_movie_<%= page_data.movie.id %>" 
                                        onclick="movieAddSaved('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')">
                                    </i>
                                    <i class="fas fa-bookmark fa-2x icon-blue"
                                        id="remove_saved_movie_<%= page_data.movie.id %>" 
                                        onclick="movieRemoveSaved('<%= user._id %>', '<%= page_data.movie.id %>', '<%= page_data.movie.runtime %>', '<%= user.permissions.user_private_key %>')">
                                    </i>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </div>
                
                <!-- Modernized info section -->
                <div class="row" style="margin-top:6px;">
                    <div class="col-md-12">
                        <div style="color: #fff; margin:6px 0 10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                            <% var year = (page_data.movie.release_date||'').toString().slice(0,4); %>
                            <% if (year) { %><span style="opacity:.85;"> <%= year %> </span><% } %>
                            <% if (page_data.movie.vote_average) { var __v = Number(page_data.movie.vote_average||0); var __vr = Math.round(__v*2)/2; var __vrStr = (__vr % 1 === 0) ? __vr.toFixed(0) : __vr.toFixed(1); %>
                            <span style="opacity:.85;">�</span>
                            <span style="opacity:.85;"> <i class="fas fa-star" style="color:#f5c518;"></i> <%= __vrStr %>/10</span>
                        <% } %>
                            <!-- <span style="opacity:.85;">•</span> -->
                            <!-- <span style="opacity:.85;"> <%= page_data.runtime %> </span> -->
                        </div>

                        <div style="margin-bottom:8px;">
                            <% (page_data.movie.genres||[]).forEach(function(genre){ %>
                                <a href="/movies?genre=<%= genre.name.toLowerCase() %>" class="badge badge-secondary" style="margin-right:6px; background:rgba(255,255,255,.08); color:#fff;"> <%= genre.name %> </a>
                            <% }); %>
                        </div>

                        <% if (page_data.movie.overview) { %>
                        <p style="font-size:16px; line-height:1.6; opacity:.95; max-width:980px;">
                            <%= page_data.movie.overview %>
                        </p>
                        <% } %>

                        <!-- New responsive info cards -->
                        <div class="info-cards">
                            <div class="row no-gutters">
                                <% if (page_data.movie.release_date) { %>
                                <div class="col-12 col-sm-6 col-md-3 p-1">
                                <div class="info-card">
                                    <div class="label">Release Date</div>
                                    <div class="value"><%= new Date(page_data.movie.release_date).toLocaleDateString() %></div>
                                </div>
                                </div>
                                <% } %>
                                <div class="col-12 col-sm-6 col-md-3 p-1">
                                <div class="info-card">
                                    <div class="label">Runtime</div>
                                    <div class="value"><%= page_data.runtime %></div>
                                </div>
                                </div>
                                <% if ((page_data.directors||[]).length) { var d0 = page_data.directors[0]; %>
                                <div class="col-12 col-sm-6 col-md-3 p-1">
                                <div class="info-card">
                                    <div class="label">Director</div>
                                    <div class="value"><a href="/person/<%= d0.id %>" style="color:#fff; text-decoration:none;"> <%= d0.name %> </a></div>
                                </div>
                                </div>
                                <% } %>
                                <% if (page_data.movie.budget) { %>
                                <div class="col-12 col-sm-6 col-md-3 p-1">
                                <div class="info-card">
                                    <div class="label">Budget</div>
                                    <div class="value">$<%= (page_data.movie.budget||0).toLocaleString('en-US') %></div>
                                </div>
                                </div>
                                <% } %>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <img class="img-fluid" src="https://image.tmdb.org/t/p/w500/<%= page_data.movie.poster_path %>" alt="">
            </div>
        <% } %>
    
        
    </div>



    <% if ((page_data.cast||[]).length) { %>
    <div>
        <style>
            .cast-row{overflow-x:auto; white-space:nowrap; flex-wrap:nowrap; padding-bottom:8px;}
            .cast-row::-webkit-scrollbar{height:6px;}
            .cast-row::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.25); border-radius:6px; }
            .cast-row{scrollbar-width:thin; scrollbar-color: rgba(255,255,255,.25) transparent;}
        </style>
        <h4 style="margin-bottom:8px; color:#fff;">Cast</h4>

        <div class="row cast-row">
            <% page_data.cast.forEach(function (p, index){ if (index < 20) { %>
                <div class="col-md-2" style="display:inline-block; float:none;">
                    <a href="/person/<%= p.id %>">
                        <% if (p.profile_path) { %>
                            <img class="img-fluid" src="https://image.tmdb.org/t/p/w185/<%= p.profile_path %>" alt="<%= p.name %>" style="border-radius:6px;">
                        <% } %>
                        <div style="color:#fff; font-weight:600; margin-top:6px;"><%= p.name %></div>
                        <div style="opacity:.8; color:#ccc; font-size:12px;">
                            <%= p.character %>
                        </div>
                    </a>
                </div>
            <% } }); %>
        </div>
    </div>
    <% } %>
    
    <!-- Similar Movies -->
    <% if ((page_data.similar||[]).length) { %>
    <div>
        <h2>Similar Movies</h2>
        <hr>

        <div class="row">
            <% page_data.similar.forEach(function (m, index){ if (index < 12) { %>
            <div class="col-md-2 image-box">
                <a href="/movies/<%= m.id %>-<%= (m.title||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').substring(0,80) %>">
                    <img class="img-fluid image-box-hover" src="https://image.tmdb.org/t/p/w500/<%= m.poster_path %>" alt="">
                </a>
                <div class="movie-hover image-box-description">
                    <div class="movie-title" title="<%= m.title %>"><%= m.title %></div>
                    <% if (typeof user != 'undefined') { %>
                    <div class="movie-actions">
                        <i class="far fa-check-circle fa-2x icon-white" id="add_watched_movie_<%= m.id %>" onclick="event.stopPropagation(); movieAddWatched('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                        <i class="fas fa-check-circle fa-2x icon-green" id="remove_watched_movie_<%= m.id %>" onclick="event.stopPropagation(); movieRemoveWatched('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                        <i class="far fa-heart fa-2x icon-white" id="add_favourited_movie_<%= m.id %>" onclick="event.stopPropagation(); movieAddFavourited('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                        <i class="fas fa-heart fa-2x icon-red" id="remove_favourited_movie_<%= m.id %>" onclick="event.stopPropagation(); movieRemoveFavourited('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                        <i class="far fa-bookmark fa-2x icon-white" id="add_saved_movie_<%= m.id %>" onclick="event.stopPropagation(); movieAddSaved('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                        <i class="fas fa-bookmark fa-2x icon-blue" id="remove_saved_movie_<%= m.id %>" onclick="event.stopPropagation(); movieRemoveSaved('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                    </div>
                    <% } %>
                </div>
            </div>
            <% } }); %>
        </div>

        <% if ((page_data.similar_all||[]).length > 12) { %>
        <div class="text-center" style="margin:10px 0;">
            <button id="movie_similar_toggle_btn" class="btn btn-secondary btn-sm">Show more similar movies</button>
        </div>
        <div id="movie_similar_more" style="display:none;">
            <div class="row">
                <% page_data.similar_all.forEach(function (m, index){ if (index >= 12) { %>
                <div class="col-md-2 image-box">
                    <a href="/movies/<%= m.id %>-<%= (m.title||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').substring(0,80) %>">
                        <img class="img-fluid image-box-hover" src="https://image.tmdb.org/t/p/w500/<%= m.poster_path %>" alt="">
                    </a>
                    <div class="movie-hover image-box-description">
                        <div class="movie-title" title="<%= m.title %>"><%= m.title %></div>
                        <% if (typeof user != 'undefined') { %>
                        <div class="movie-actions">
                            <i class="far fa-check-circle fa-2x icon-white" id="add_watched_movie_<%= m.id %>" onclick="event.stopPropagation(); movieAddWatched('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                            <i class="fas fa-check-circle fa-2x icon-green" id="remove_watched_movie_<%= m.id %>" onclick="event.stopPropagation(); movieRemoveWatched('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                            <i class="far fa-heart fa-2x icon-white" id="add_favourited_movie_<%= m.id %>" onclick="event.stopPropagation(); movieAddFavourited('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                            <i class="fas fa-heart fa-2x icon-red" id="remove_favourited_movie_<%= m.id %>" onclick="event.stopPropagation(); movieRemoveFavourited('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                            <i class="far fa-bookmark fa-2x icon-white" id="add_saved_movie_<%= m.id %>" onclick="event.stopPropagation(); movieAddSaved('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                            <i class="fas fa-bookmark fa-2x icon-blue" id="remove_saved_movie_<%= m.id %>" onclick="event.stopPropagation(); movieRemoveSaved('<%= user._id %>', '<%= m.id %>', '', '<%= user.permissions.user_private_key %>'); return false;"></i>
                        </div>
                        <% } %>
                    </div>
                </div>
                <% } }); %>
            </div>
        </div>
        <% } %>
    </div>
    <% } %>
    
    </div>

<script>
(function(){
  document.addEventListener('DOMContentLoaded', function(){
    try {
      <% if (typeof user != 'undefined') { %>
      // Initialize main movie quick-action state
      checkIfWatched('<%= user._id %>', String(<%= page_data.movie.id %>));
      checkIfFavourited('<%= user._id %>', String(<%= page_data.movie.id %>));
      checkIfSaved('<%= user._id %>', String(<%= page_data.movie.id %>));

      // Initialize first 12 similar movies
      (function(){
        var ids = <%- JSON.stringify((page_data.similar||[]).map(function(m){ return m && m.id; }).filter(Boolean)) %>;
        ids.forEach(function(mid){
          checkIfWatched('<%= user._id %>', String(mid));
          checkIfFavourited('<%= user._id %>', String(mid));
          checkIfSaved('<%= user._id %>', String(mid));
        });
      })();
      <% } %>
    } catch(_){}

    // Toggle for "Similar Movies" section
    try {
      var btn = document.getElementById('movie_similar_toggle_btn');
      var more = document.getElementById('movie_similar_more');
      if (btn && more) {
        var didInitMore = false;
        btn.addEventListener('click', function(){
          var visible = more.style.display !== 'none';
          if (visible) {
            more.style.display = 'none';
            btn.textContent = 'Show more similar movies';
          } else {
            more.style.display = '';
            btn.textContent = 'Show fewer similar movies';
            <% if (typeof user != 'undefined') { %>
            if (!didInitMore) {
              didInitMore = true;
              try {
                var moreIds = <%- JSON.stringify((page_data.similar_all||[]).slice(12).map(function(m){ return m && m.id; }).filter(Boolean)) %>;
                moreIds.forEach(function(mid){
                  checkIfWatched('<%= user._id %>', String(mid));
                  checkIfFavourited('<%= user._id %>', String(mid));
                  checkIfSaved('<%= user._id %>', String(mid));
                });
              } catch(_){}
            }
            <% } %>
          }
        });
      }
    } catch(_){}
  });
})();
</script>

<!-- Reviews -->
<div class="container" style="margin-top:18px;">
  <div class="row">
    <div class="col-md-12">
      <h2>Reviews</h2>
      <div id="movie_reviews_summary" style="opacity:.85; margin-bottom:8px;"></div>
      <% if (typeof user != 'undefined') { %>
      <div class="card" style="background:#151515;border:1px solid #2a2a2a;margin-bottom:12px;border-radius:10px;">
        <div class="card-body" style="color:#ffff;">
          <h5>Your review</h5>
          <div class="form-row" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
            <input id="rv_title" class="form-control" placeholder="Title" style="max-width:320px;" />
            <div id="rv_star_widget" class="rv-stars" style="cursor:pointer; display:inline-flex; gap:4px; font-size:22px; color:#f5c518;">
              <i class="far fa-star"></i>
              <i class="far fa-star"></i>
              <i class="far fa-star"></i>
              <i class="far fa-star"></i>
              <i class="far fa-star"></i>
            </div>
            <span id="rv_star_label" style="opacity:.9; font-size:12px;">0.0 / 5</span>
          </div>
          <textarea id="rv_text" class="form-control" rows="3" placeholder="Write your review..." style="margin-top:8px;"></textarea>
          <div id="rv_text_count" style="opacity:.7; font-size:12px; margin-top:4px;">0/500</div>
          <button id="rv_submit" class="btn btn-primary" style="margin-top:8px;">Save review</button>
        </div>
      </div>
      <% } else { %>
        <div style="margin:8px 0; opacity:.85;">Please <a style="color: lightblue;" href="/login">log in</a> to write a review.</div>
      <% } %>
      <div id="movie_reviews_list"></div>
    </div>
  </div>
</div>

<script>
(function(){
  var ITEM_TYPE = 'movie';
  var ITEM_ID = <%- JSON.stringify(String(page_data.movie && page_data.movie.id || '')) %>;
  var ME = <%- JSON.stringify(typeof user != 'undefined' ? { _id: String(user._id), key: String(user.permissions && user.permissions.user_private_key || '') } : null) %>;
  var listEl, sumEl, starWrap, starLabel, starValue = 0, hoverValue = 0;

  function fmtStars(v){ var s = Number(v||0); return s.toFixed(1) + ' / 5'; }
  function drawStars(v){
    try {
      if (!starWrap) return;
      v = Math.max(0, Math.min(5, Math.round(v*2)/2));
      var html = '';
      for (var i=1;i<=5;i++){
        if (v >= i) html += '<i class="fas fa-star"></i>';
        else if (v >= (i-0.5)) html += '<i class="fas fa-star-half-alt"></i>';
        else html += '<i class="far fa-star"></i>';
      }
      starWrap.innerHTML = html;
      if (starLabel) starLabel.textContent = fmtStars(v);
    } catch(_){}
  }

  function setupStars(){
    starWrap = document.getElementById('rv_star_widget');
    starLabel = document.getElementById('rv_star_label');
    if (!starWrap) return;
    drawStars(starValue);
    function compute(e){
      var rect = starWrap.getBoundingClientRect();
      var rel = (e.clientX - rect.left) / Math.max(1, rect.width);
      var v = Math.max(0, Math.min(1, rel)) * 5; // 0..5
      v = Math.round(v*2)/2;
      return v;
    }
    starWrap.addEventListener('mousemove', function(e){ hoverValue = compute(e); drawStars(hoverValue); });
    starWrap.addEventListener('mouseleave', function(){ drawStars(starValue); });
    starWrap.addEventListener('click', function(e){ starValue = compute(e); drawStars(starValue); });
  }

  function load(){
    fetch('/api/v1/reviews?type='+ITEM_TYPE+'&id='+encodeURIComponent(ITEM_ID))
      .then(r=>r.json()).then(function(d){
        var avg = d.average||0, count = d.count||0;
        sumEl.innerHTML = count ? ('Average rating: <b>'+fmtStars(avg)+'</b> ('+count+' reviews)') : 'No reviews yet';
        renderList(d.items||[]);
      }).catch(function(){ renderList([]); });
  }

  function esc(s){ return (s||'').replace(/[&<>"']/g, function(c){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'})[c]||c; }); }
  function renderList(items){
    listEl.innerHTML='';
    items.forEach(function(r){
      var canEdit = ME && String(r.author_id||'') === String(ME._id);
      var upCls = r.user_vote==='up' ? 'btn-success' : 'btn-outline-secondary';
      var downCls = r.user_vote==='down' ? 'btn-danger' : 'btn-outline-secondary';
      var card = document.createElement('div');
      card.className = 'card';
      card.style.cssText = 'background:#151515;border:1px solid #2a2a2a;margin-bottom:12px;border-radius:10px;';
      card.innerHTML = '<div class="card-body" style="color:#ffff;">'
        + '<div style="display:flex; align-items:center; gap:10px;">'
        +   '<img src="'+esc(r.user_avatar||'/static/style/img/standard/standard_avatar.png')+'" style="width:28px;height:28px;border-radius:50%;object-fit:cover;">'
        +   '<div style="flex:1;">'
        +     '<div><a href="'+esc(r.user_link||'#')+'" style="color:lightblue;">'+esc(r.username||'user')+'</a></div>'
        +     '<div style="opacity:.8; font-size:12px;">'+new Date(r.created_at).toLocaleString()+'</div>'
        +   '</div>'
        +   '<div><span class="badge badge-info">'+fmtStars(r.stars)+'</span></div>'
        + '</div>'
        + '<h5 style="margin-top:8px;">'+esc(r.title||'')+'</h5>'
        + '<div>'+(esc(r.text||'').replace(/\n/g,'<br>'))+'</div>'
        + '<div style="margin-top:8px; display:flex; gap:8px; align-items:center;">'
        +   (canEdit ? '<button class="btn btn-sm btn-secondary js-edit" data-id="'+r._id+'">Edit</button>' : '')
        +   (canEdit ? '<button class="btn btn-sm btn-outline-danger js-del" data-id="'+r._id+'">Delete</button>' : '')
        +   '<div class="btn-group btn-group-sm" role="group">'
        +     '<button class="btn '+upCls+' js-vote" data-id="'+r._id+'" data-action="up"><i class="fas fa-arrow-up"></i> <span class="js-up">'+(r.upvote_count||0)+'</span></button>'
        +     '<button class="btn '+downCls+' js-vote" data-id="'+r._id+'" data-action="down"><i class="fas fa-arrow-down"></i> <span class="js-down">'+(r.downvote_count||0)+'</span></button>'
        +   '</div>'
        + '</div>'
        + '<div class="mt-2">'
        +   '<button class="btn btn-sm btn-outline-secondary js-show-cmt" data-id="'+r._id+'">Comments</button>'
        +   '<button class="btn btn-sm btn-outline-danger js-report-review" data-id="'+r._id+'" data-uid="'+(r.author_id||'')+'">Report</button>'
        +   '<div class="js-cmt-wrap" id="cmt_'+r._id+'" style="display:none; margin-top:8px;"></div>'
        + '</div>'
        + '</div>';
      listEl.appendChild(card);
      // auto-load comments for each review
      var wrap = card.querySelector('#cmt_'+r._id+'');
      if (wrap) { loadComments(r._id, wrap); }
    });
    bindListHandlers();
  }

  function bindListHandlers(){
    listEl.querySelectorAll('.js-vote').forEach(function(btn){
      btn.onclick = function(){
        if(!ME) return alert('Please log in to vote.');
        var id = this.getAttribute('data-id');
        var act = this.getAttribute('data-action');
        fetch('/api/v1/reviews/'+id+'/vote', { method:'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify({ user_id: ME._id, user_key: ME.key, vote: act }) })
          .then(r=>r.json()).then(load);
      };
    });
    listEl.querySelectorAll('.js-edit').forEach(function(btn){
      btn.onclick = function(){
        var id = this.getAttribute('data-id');
        var t = prompt('New title:'); if(t==null) return;
        var s = prompt('New stars (0-5, halves ok):'); if(s==null) return;
        var x = prompt('New text:'); if(x==null) return;
        fetch('/api/v1/reviews/'+id+'/edit', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: ME._id, user_key: ME.key, title: t, stars: Number(s||0), text: x }) }).then(load);
      };
    });
    listEl.querySelectorAll('.js-del').forEach(function(btn){
      btn.onclick = function(){
        if(!confirm('Delete this review?')) return;
        var id = this.getAttribute('data-id');
        fetch('/api/v1/reviews/'+id+'/delete', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: ME._id, user_key: ME.key }) }).then(load);
      };
    });
    listEl.querySelectorAll('.js-show-cmt').forEach(function(btn){
      btn.onclick = function(){
        var id = this.getAttribute('data-id');
        var wrap = document.getElementById('cmt_'+id);
        if (wrap.getAttribute('data-loaded')==='1') { wrap.style.display = (wrap.style.display==='none'?'block':'none'); return; }
        loadComments(id, wrap);
      };
    });
  }

  function loadComments(rid, wrap){
    wrap.innerHTML = '<div>Loading...</div>';
    fetch('/api/v1/reviews/'+rid).then(r=>r.json()).then(function(d){
      var r = d.review; if(!r){ wrap.innerHTML='<div>No comments</div>'; return; }
      var comments = Array.isArray(r.comments)?r.comments:[];
      var out = '';
      comments.forEach(function(c){
        var body = c.deleted ? '<em style="opacity:.8;">-deleted-</em>' : (String(c.message||'').replace(/\n/g,'<br>'));
        out += '<div style="border:1px solid #2a2a2a; background:#101010; padding:8px; border-radius:8px; margin-bottom:6px;">'
            + '<div style="opacity:.85; font-size:12px;">'+(c.username||'')+' • '+new Date(c.created_at).toLocaleString()+'</div>'
            + '<div>'+ body +'</div>'
            + '</div>';
      });
      if (ME) {
        out += '<div class="card" style="background:#151515;border:1px solid #2a2a2a;border-radius:10px;">'
          + '<div class="card-body" style="color:#ffff;">'
          + '<textarea class="form-control" id="cmt_new_'+rid+'" rows="2" placeholder="Add a comment..."></textarea>'
          + '<button class="btn btn-primary" style="margin-top:6px;" data-id="'+rid+'" id="cmt_send_'+rid+'">Post</button>'
          + '</div></div>';
      }
      wrap.innerHTML = out || '<div>No comments yet.</div>';
      wrap.style.display = 'block';
      wrap.setAttribute('data-loaded','1');
      if (ME) {
        var btn = document.getElementById('cmt_send_'+rid);
        btn && (btn.onclick = function(){
          var ta = document.getElementById('cmt_new_'+rid);
          var msg = (ta && ta.value||'').trim(); if(!msg) return;
          fetch('/api/v1/reviews/'+rid+'/comment', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: ME._id, user_key: ME.key, message: msg }) }).then(function(){ loadComments(rid, wrap); });
        });
        // Normalize deleted comment display
        try {
          var nodes = wrap.children || [];
          for (var j=0; j<comments.length; j++){
            var cc = comments[j]; var el = nodes[j]; if (!cc || !el) continue;
            if (cc.deleted && el.children && el.children[1]) { el.children[1].innerHTML = '<em style="opacity:.8;">-deleted-</em>'; }
          }
        } catch(_){}
        // Append action controls for each comment (edit/delete/report)
        try {
          var isAdmin = <%- JSON.stringify(typeof user != 'undefined' && user.permissions && user.permissions.level && user.permissions.level.admin) %>;
          for (var i=0; i<comments.length; i++){
            var c = comments[i]; var el = wrap.children[i]; if (!el || !c || c.deleted) continue;
            var isOwner = <%- JSON.stringify(typeof user != 'undefined' ? String(user._id) : '') %> === String(c.user_id||'');
            var actions = document.createElement('div');
            actions.style.cssText = 'margin-top:6px; display:flex; gap:6px; flex-wrap:wrap;';
            if (isOwner){ var e=document.createElement('button'); e.className='btn btn-sm btn-outline-secondary'; e.textContent='Edit'; e.onclick=function(cc){ return function(){ var txt=prompt('Edit comment:'); if(txt==null) return; fetch('/api/v1/reviews/'+rid+'/comment/'+cc._id+'/edit', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: ME._id, user_key: ME.key, message: txt })}).then(function(){ loadComments(rid, wrap); }); }; }(c); actions.appendChild(e); }
            if (isOwner || isAdmin){ var d=document.createElement('button'); d.className='btn btn-sm btn-outline-danger'; d.textContent='Delete'; d.onclick=function(cc){ return function(){ fetch('/api/v1/reviews/'+rid+'/comment/'+cc._id+'/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: ME._id, user_key: ME.key, mode: 'soft' })}).then(function(){ loadComments(rid, wrap); }); }; }(c); actions.appendChild(d); }
            if (isAdmin){ var hd=document.createElement('button'); hd.className='btn btn-sm btn-danger'; hd.textContent='Hard delete'; hd.onclick=function(cc){ return function(){ if(!confirm('Hard delete?')) return; fetch('/api/v1/reviews/'+rid+'/comment/'+cc._id+'/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: ME._id, user_key: ME.key, mode: 'hard' })}).then(function(){ loadComments(rid, wrap); }); }; }(c); actions.appendChild(hd); }
            var rep=document.createElement('button'); rep.className='btn btn-sm btn-outline-warning'; rep.textContent='Report'; rep.onclick=function(cc){ return function(){ var reason=prompt('Reason for report?'); if(reason==null) return; fetch('/api/v1/reports', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ reported_user_id: cc.user_id, reason: reason, context: 'comment', meta: { review_id: rid, comment_id: cc._id } })}).then(function(){ alert('Reported'); }); }; }(c); actions.appendChild(rep);
            el.appendChild(actions);
          }
        } catch(_){ }
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function(){
    listEl = document.getElementById('movie_reviews_list');
    sumEl = document.getElementById('movie_reviews_summary');
    setupStars();
    load();
    // live char counter (UI hint; server enforces)
    try {
      var maxLen = 500; var ta = document.getElementById('rv_text'); var ct = document.getElementById('rv_text_count');
      if (ta && ct){ ta.addEventListener('input', function(){ var n=(ta.value||'').length; ct.textContent = n+'/'+maxLen; ct.style.color = (n>maxLen)?'#ff6b6b':'#aaa'; }); }
    } catch(_){}
    var btn = document.getElementById('rv_submit');
    if (ME && btn){
      btn.onclick = function(){
        var t = document.getElementById('rv_title').value||'';
        var x = document.getElementById('rv_text').value||'';
        // simple client-side limit indicator
        var maxLen = 500; // server enforces via setting; keep UI hint
        if (x.length > maxLen){ alert('Review is too long ('+x.length+'/'+maxLen+').'); return; }
        fetch('/api/v1/reviews', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: ME._id, user_key: ME.key, type: ITEM_TYPE, id: ITEM_ID, title: t, stars: starValue, text: x }) })
          .then(load);
      };
    }
    // report review buttons
    document.addEventListener('click', function(e){
      var el = e.target.closest('.js-report-review');
      if(!el) return;
      var rid = el.getAttribute('data-id');
      var uid = el.getAttribute('data-uid');
      var reason = prompt('Reason for report?');
      if(reason==null) return;
      fetch('/api/v1/reports', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ reported_user_id: uid, reason: reason, context: 'review', meta: { review_id: rid } })}).then(function(){ alert('Reported'); });
    });
  });
})();
</script>
